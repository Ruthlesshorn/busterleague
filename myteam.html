<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buster League 2026 ‚Äî My Team</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; color: #333; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #d94e59 100%);
            color: white; padding: 24px 30px; border-radius: 12px;
            margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;
        }
        .header-left h1 { font-family: 'Bebas Neue', sans-serif; font-size: 2em; letter-spacing: 2px; }
        .header-left p { opacity: 0.85; font-size: 0.9em; margin-top: 2px; }
        .header-right { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        .btn {
            padding: 10px 20px; border-radius: 8px; font-family: 'DM Sans', sans-serif;
            font-weight: 700; font-size: 0.9em; cursor: pointer; border: none;
            text-decoration: none; display: inline-block; transition: all 0.2s;
        }
        .btn-white { background: white; color: #c41e3a; }
        .btn-white:hover { background: #f8f9fa; transform: translateY(-1px); }
        .btn-ghost { background: rgba(255,255,255,0.2); color: white; }
        .btn-ghost:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }
        .btn-red { background: #c41e3a; color: white; }
        .btn-red:hover { background: #a01830; }
        .btn-sm { padding: 6px 14px; font-size: 0.82em; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }

        .card { background: white; border-radius: 12px; padding: 22px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
        .card h2 {
            font-size: 0.85em; font-weight: 800; letter-spacing: 2px; text-transform: uppercase;
            color: #1e3c72; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid #c41e3a;
            display: flex; justify-content: space-between; align-items: center;
        }
        .card h2 span { font-size: 1.1em; font-weight: 600; color: #6c757d; letter-spacing: 0; text-transform: none; }

        /* Roster table */
        .mini-table { width: 100%; border-collapse: collapse; font-size: 0.88em; }
        .mini-table thead { background: #1e3c72; color: white; }
        .mini-table th { padding: 9px 10px; text-align: left; font-weight: 600; white-space: nowrap; }
        .mini-table td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; }
        .mini-table tbody tr:hover { background: #f8f9fa; }

        .pos-badge { background: #c41e3a; color: white; padding: 2px 7px; border-radius: 4px; font-weight: 700; font-size: 0.78em; }
        .k-badge { background: #d1ecf1; color: #0c5460; padding: 2px 7px; border-radius: 4px; font-weight: 700; font-size: 0.78em; }
        .d-badge { background: #e2e3e5; color: #383d41; padding: 2px 7px; border-radius: 4px; font-weight: 700; font-size: 0.78em; }

        /* Needs */
        .search-controls input:focus, .search-controls select:focus { outline: none; border-color: #c41e3a; }
        .search-controls input { flex: 1; min-width: 180px; }

        .player-table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid #dee2e6; max-height: 500px; overflow-y: auto; }
        .player-table { width: 100%; border-collapse: collapse; font-size: 0.87em; }
        .player-table thead { background: #1e3c72; color: white; position: sticky; top: 0; z-index: 5; }
        .player-table th { padding: 10px 12px; text-align: left; font-weight: 600; white-space: nowrap; }
        .player-table td { padding: 9px 12px; border-bottom: 1px solid #f0f0f0; white-space: nowrap; }
        .player-table tbody tr:hover { background: #f8f9fa; }
        .player-table tbody tr.unavailable { opacity: 0.4; }
        .player-table tbody tr.watched { background: #fffbf0; }
        .player-table tbody tr.watched:hover { background: #fff3cd; }

        .watch-btn {
            padding: 4px 12px; border-radius: 20px; border: 2px solid #dee2e6;
            background: white; font-family: 'DM Sans', sans-serif; font-size: 0.78em;
            font-weight: 700; cursor: pointer; transition: all 0.2s; white-space: nowrap;
            color: #6c757d;
        }
        .watch-btn:hover { border-color: #ffc107; color: #856404; background: #fffbf0; }
        .watch-btn.watching { background: #ffc107; border-color: #ffc107; color: #1a1a1a; }
        .watch-btn.watching:hover { background: #e6ac00; border-color: #e6ac00; }

        .watchlist-empty { text-align: center; padding: 30px; color: #6c757d; font-style: italic; }

        .btn-col-picker {
            padding: 9px 16px; border-radius: 8px; border: 2px solid #dee2e6;
            background: white; font-family: 'DM Sans', sans-serif; font-size: 0.9em;
            font-weight: 700; cursor: pointer; color: #495057; transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-col-picker:hover { border-color: #1e3c72; color: #1e3c72; }
        .btn-col-picker.active { background: #1e3c72; border-color: #1e3c72; color: white; }

        #col-picker {
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 10px;
            margin: 12px 0; overflow: hidden;
        }
        .col-picker-inner { padding: 16px; }
        .col-picker-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; font-weight: 700; font-size: 0.85em;
            color: #1e3c72; text-transform: uppercase; letter-spacing: 1px;
        }
        .col-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 6px;
        }
        .col-checkbox-grid label {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.82em; font-weight: 500; color: #495057;
            cursor: pointer; padding: 5px 8px; border-radius: 6px;
            border: 1px solid #dee2e6; background: white;
            transition: all 0.15s; user-select: none;
            text-transform: none; letter-spacing: 0;
        }
        .col-checkbox-grid label:hover { border-color: #1e3c72; color: #1e3c72; }
        .col-checkbox-grid input[type=checkbox] { accent-color: #1e3c72; }
        .col-checkbox-grid label.checked { background: #e8eef8; border-color: #1e3c72; color: #1e3c72; font-weight: 700; }
        .btn-tiny {
            padding: 4px 10px; border-radius: 5px; border: 1px solid #dee2e6;
            background: white; font-family: 'DM Sans', sans-serif; font-size: 0.78em;
            font-weight: 700; cursor: pointer; color: #495057;
        }
        .btn-tiny:hover { background: #f0f0f0; }
        .btn-save { background: #1e3c72 !important; color: white !important; border-color: #1e3c72 !important; }
        .btn-save:hover { background: #2a5298 !important; }
        .save-toast {
            position: fixed; bottom: 24px; right: 24px;
            background: #28a745; color: white; padding: 12px 20px;
            border-radius: 8px; font-weight: 700; font-size: 0.9em;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            transform: translateY(60px); opacity: 0;
            transition: all 0.3s; pointer-events: none; z-index: 9999;
        }
        .save-toast.show { transform: translateY(0); opacity: 1; }
    
        /* Position requirements grid (matches team dashboard) */
        .needs-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .need-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid transparent;
        }
        .need-item.complete { border-color: #28a745; background: #f0fff4; }
        .need-item.close    { border-color: #ffc107; background: #fffdf0; }
        .need-item.needed   { border-color: #dee2e6; }
        .need-pos  { font-weight: 800; font-size: 1em; color: #1e3c72; }
        .need-count { font-weight: 700; font-size: 1em; }
        .need-count.complete { color: #28a745; }
        .need-count.close    { color: #e6a800; }
        .need-count.needed   { color: #c41e3a; }
        .need-remaining { font-size: 0.8em; color: #6c757d; margin-top: 2px; }
        /* Position breakdown grid */
        .pos-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        .pos-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        .pos-box-label {
            font-size: 0.7em;
            font-weight: 800;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 4px;
        }
        .pos-box-count {
            font-size: 1.6em;
            font-weight: 800;
            color: #1e3c72;
        }

        /* Full-width roster/watchlist cards */
        .full-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            margin-top: 20px;
        }
        .full-card h2 {
            font-size: 1.1em;
            font-weight: 800;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #1e3c72;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid #c41e3a;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .full-card h2 span {
            font-size: 0.85em;
            font-weight: 600;
            color: #6c757d;
            letter-spacing: 0;
            text-transform: none;
        }
        /* Header layout */
        .header-left { flex: 1; }
        /* Search controls */
        .search-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 14px;
            align-items: center;
        }
        .search-controls input,
        .search-controls select {
            padding: 8px 12px;
            border: 1.5px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.9em;
            font-family: inherit;
            background: white;
        }
        .search-controls input:focus,
        .search-controls select:focus {
            outline: none;
            border-color: #c41e3a;
        }


        /* √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Rankings √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ */
        #rankings-panel {
            background: #f8f9fa;
            border: 2px solid #1e3c72;
            border-radius: 12px;
            padding: 16px 20px 20px;
            margin-bottom: 14px;
        }
        .rankings-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 14px;
            align-items: center;
            flex-wrap: wrap;
        }
        .rtab {
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid #dee2e6;
            background: white;
            font-size: 0.82em;
            font-weight: 700;
            cursor: pointer;
            color: #495057;
            transition: all 0.15s;
        }
        .rtab:hover { border-color: #1e3c72; color: #1e3c72; }
        .rtab.rtab-active { background: #1e3c72; color: white; border-color: #1e3c72; }
        .rtab-hint { font-size: 0.75em; color: #adb5bd; margin-left: 4px; }
        .rankings-tab-pane { }
        .rankings-list-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .rankings-list-name {
            font-size: 0.9em;
            font-weight: 700;
            color: #1e3c72;
            border: none;
            border-bottom: 2px solid #dee2e6;
            background: transparent;
            padding: 3px 6px;
            flex: 1;
            max-width: 220px;
            font-family: inherit;
        }
        .rankings-list-name:focus { outline: none; border-bottom-color: #1e3c72; }
        .rlist-loaded { display: flex; align-items: center; gap: 8px; font-size: 0.82em; color: #28a745; font-weight: 700; }
        .rankings-drop-zone {
            border: 2px dashed #adb5bd;
            border-radius: 8px;
            padding: 22px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            margin-bottom: 10px;
        }
        .rankings-drop-zone:hover, .rankings-drop-zone.drag-over {
            border-color: #1e3c72; background: #eef2ff;
        }
        .rankings-drop-zone .dz-icon { font-size: 1.8em; display: block; margin-bottom: 4px; }
        .rankings-drop-zone .dz-text { color: #495057; font-size: 0.88em; }
        .rankings-drop-zone .dz-sub  { color: #6c757d; font-size: 0.76em; margin-top: 3px; display: block; }
        .col-map-section { }
        .col-map-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        .col-map-row label {
            display: block;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #495057;
            margin-bottom: 4px;
        }
        .col-map-row select {
            width: 100%;
            padding: 6px 10px;
            border: 1.5px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.86em;
            font-family: inherit;
            background: white;
        }
        .rankings-status {
            font-size: 0.84em;
            padding: 7px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: none;
        }
        .rankings-status.ok    { background: #d1e7dd; color: #0a3622; display: block; }
        .rankings-status.error { background: #f8d7da; color: #58151c; display: block; }
        .rankings-status.info  { background: #cff4fc; color: #055160; display: block; }
        .rankings-actions { display: flex; gap: 8px; }
        .rank-badge {
            display: inline-block;
            font-weight: 800;
            font-size: 0.76em;
            border-radius: 4px;
            padding: 2px 6px;
            min-width: 26px;
            text-align: center;
            color: white;
        }
        .rank-top10  { background: #c41e3a; }
        .rank-top25  { background: #d97706; }
        .rank-normal { background: #1e3c72; }
        .col-order-chip { display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:6px;border:1.5px solid #dee2e6;background:white;font-size:0.82em;font-weight:600;cursor:grab;user-select:none;margin:2px; }
        .col-order-chip:hover { border-color:#1e3c72;background:#e8eef8; }
        .col-order-chip.hidden-col { opacity:0.45;background:#f8f9fa; }
        .col-order-chip.drag-over { border-color:#c41e3a;background:#fff0f0; }
        .drag-handle { cursor:grab;color:#aaa; }
        .col-eye { cursor:pointer;font-size:0.9em; }
        .col-order-grid { display:flex;flex-wrap:wrap;gap:4px;padding:8px 0; }
                th.sortable  { cursor: pointer; user-select: none; }
        th.sortable:after  { content: ' ‚áÖ'; opacity: 0.35; font-size: 0.78em; }
        th.sort-asc:after  { content: ' ‚Üë'; opacity: 1; }
        th.sort-desc:after { content: ' ‚Üì'; opacity: 1; }

        /* Watchlist position filter chips */
        .wl-pos-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 0 14px;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 14px;
        }
        .wl-pos-filter-label {
            font-size: 0.75em;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #6c757d;
            margin-right: 4px;
        }
        .pos-chip {
            display: inline-block;
            padding: 4px 11px;
            border-radius: 20px;
            border: 2px solid #dee2e6;
            background: white;
            font-size: 0.78em;
            font-weight: 800;
            cursor: pointer;
            color: #495057;
            transition: all 0.12s;
            user-select: none;
            letter-spacing: 0.5px;
        }
        .pos-chip:hover { border-color: #1e3c72; color: #1e3c72; }
        .pos-chip.active {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }
        .pos-chip.chip-all.active {
            background: #6c757d;
            border-color: #6c757d;
        }
        .pos-chip.chip-sp.active, .pos-chip.chip-rp.active {
            background: #c41e3a;
            border-color: #c41e3a;
        }
        .wl-filter-info {
            font-size: 0.78em;
            color: #6c757d;
            margin-left: auto;
            font-style: italic;
        }

        /* √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Do Not Want √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ */
        .dnw-btn {
            padding: 4px 10px;
            border-radius: 20px;
            border: 2px solid #dee2e6;
            background: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78em;
            font-weight: 700;
            cursor: pointer;
            color: #adb5bd;
            transition: all 0.15s;
        }
        .dnw-btn:hover { border-color: #dc3545; color: #dc3545; }
        .dnw-btn.dnw-active {
            background: #fff0f0;
            border-color: #dc3545;
            color: #dc3545;
        }
        tr.dnw-row { opacity: 0.38; text-decoration: line-through; }
        tr.dnw-row:hover { opacity: 0.6; }
        .dnw-badge {
            display: inline-block;
            background: #fff0f0;
            color: #dc3545;
            border: 1.5px solid #dc3545;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 800;
            padding: 1px 7px;
            letter-spacing: 0.3px;
        }
</style>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Firebase Configuration -->
    <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBpsal5vJ1b4nEjAfyQH1baKFRcuPV4QxI",
      authDomain: "buster-league-draft.firebaseapp.com",
      databaseURL: "https://buster-league-draft-default-rtdb.firebaseio.com",
      projectId: "buster-league-draft",
      storageBucket: "buster-league-draft.firebasestorage.app",
      messagingSenderId: "410413976342",
      appId: "1:410413976342:web:2ed683daa1c808a2aa9e37",
      measurementId: "G-DNJ7MC9VLW"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.firebaseApp = app;
    window.firebaseDB = db;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseGet = get;
    window.firebaseOnValue = onValue;
    window.firebaseInitialized = true;
    console.log('Firebase initialized');
    </script>
</head>
<body>
<div class="container">

    <div class="header">
        <div class="header-left">
            <h1 id="team-heading">‚öæ My Team</h1>
            <p id="team-sub">Buster League Draft 2026</p>
        </div>
        <div class="header-right">
            <a href="index.html" class="btn btn-ghost">Dashboard</a>
            <button class="btn btn-white" onclick="logout()">Sign Out</button>
        </div>
    </div>

    <!-- Top row: Position Requirements + Draft Picks side by side -->
    <div class="grid">
        <div class="card">
            <h2>Position Requirements</h2>
            <div class="needs-grid" id="needs-grid"></div>
            <h2 style="margin-top:20px;">Position Breakdown</h2>
            <div class="pos-breakdown" id="pos-breakdown"></div>
        </div>
        <div class="card">
            <h2 style="margin-bottom:12px;">Draft Picks <span id="picks-label"></span></h2>
            <table class="mini-table">
                <thead><tr><th>Round</th><th>Pick #</th><th>Player</th><th>Pos</th></tr></thead>
                <tbody id="my-picks-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- Full-width Hitters -->
    <div class="full-card">
        <div id="roster-pos-filter-hitter" style="margin-bottom:6px;"></div>
        <h2>Rostered Hitters <span id="hitter-count-label"></span><button class="btn-col-picker" style="font-size:0.7em;padding:5px 12px;" onclick="toggleRosterColPicker('hitter')">‚öô Columns</button></h2><div id="col-picker-roster-hitter" style="display:none;"><div class="col-picker-inner"><div class="col-picker-header"><span>Hitter Columns</span><div style="display:flex;gap:8px;"><button class="btn-tiny" onclick="selectAllRosterCols('hitter')">All</button><button class="btn-tiny" onclick="selectNoneRosterCols('hitter')">None</button><button class="btn-tiny" id="roster-reorder-btn-hitter" onclick="toggleRosterReorder('hitter')" style="background:#e8eef8;border-color:#1e3c72;color:#1e3c72;">‚áÖ Reorder</button><button class="btn-tiny btn-save" onclick="saveRosterColPrefs()">üíæ Save</button></div></div><div id="col-checkboxes-roster-hitter" class="col-checkbox-grid"></div></div></div>
        <div class="player-table-wrap" style="overflow-x:auto;">
            <table class="player-table">
                <thead id="hitter-roster-thead"></thead>
                <tbody id="hitter-roster-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- Full-width Pitchers -->
    <div class="full-card">
        <div id="roster-pos-filter-pitcher" style="margin-bottom:6px;"></div>
        <h2>Rostered Pitchers <span id="pitcher-count-label"></span><button class="btn-col-picker" style="font-size:0.7em;padding:5px 12px;" onclick="toggleRosterColPicker('pitcher')">‚öô Columns</button></h2><div id="col-picker-roster-pitcher" style="display:none;"><div class="col-picker-inner"><div class="col-picker-header"><span>Pitcher Columns</span><div style="display:flex;gap:8px;"><button class="btn-tiny" onclick="selectAllRosterCols('pitcher')">All</button><button class="btn-tiny" onclick="selectNoneRosterCols('pitcher')">None</button><button class="btn-tiny" id="roster-reorder-btn-pitcher" onclick="toggleRosterReorder('pitcher')" style="background:#e8eef8;border-color:#1e3c72;color:#1e3c72;">‚áÖ Reorder</button><button class="btn-tiny btn-save" onclick="saveRosterColPrefs()">üíæ Save</button></div></div><div id="col-checkboxes-roster-pitcher" class="col-checkbox-grid"></div></div></div>
        <div class="player-table-wrap" style="overflow-x:auto;">
            <table class="player-table">
                <thead id="pitcher-roster-thead"></thead>
                <tbody id="pitcher-roster-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- Watchlist -->
    <div class="full-card">
        <h2>‚≠ê My Watchlist <span id="watchlist-count"></span>
            <button class="btn-col-picker" style="font-size:0.7em;padding:5px 12px;margin-left:10px;" onclick="toggleWatchlistColPicker('hitter')">‚öô Hitter Cols</button>
            <button class="btn-col-picker" style="font-size:0.7em;padding:5px 12px;" onclick="toggleWatchlistColPicker('pitcher')">‚öô Pitcher Cols</button>
        </h2>

        <!-- Watchlist hitter col picker -->
        <div id="col-picker-wl-hitter" style="display:none;">
            <div class="col-picker-inner">
                <div class="col-picker-header">
                    <span>Watchlist Hitter Columns</span>
                    <div style="display:flex;gap:8px;">
                        <button class="btn-tiny" onclick="selectAllWLCols('hitter')">All</button>
                        <button class="btn-tiny" onclick="selectNoneWLCols('hitter')">None</button>
                        <button class="btn-tiny" id="wl-reorder-btn-hitter" onclick="toggleWLReorder('hitter')" style="background:#e8eef8;border-color:#1e3c72;color:#1e3c72;">&#8597; Reorder</button>
                        <button class="btn-tiny btn-save" onclick="saveWLColPrefs()">üíæ Save</button>
                    </div>
                </div>
                <div id="col-checkboxes-wl-hitter" class="col-checkbox-grid"></div>
            </div>
        </div>

        <!-- Watchlist pitcher col picker -->
        <div id="col-picker-wl-pitcher" style="display:none;">
            <div class="col-picker-inner">
                <div class="col-picker-header">
                    <span>Watchlist Pitcher Columns</span>
                    <div style="display:flex;gap:8px;">
                        <button class="btn-tiny" onclick="selectAllWLCols('pitcher')">All</button>
                        <button class="btn-tiny" onclick="selectNoneWLCols('pitcher')">None</button>
                        <button class="btn-tiny" id="wl-reorder-btn-pitcher" onclick="toggleWLReorder('pitcher')" style="background:#e8eef8;border-color:#1e3c72;color:#1e3c72;">&#8597; Reorder</button>
                        <button class="btn-tiny btn-save" onclick="saveWLColPrefs()">üíæ Save</button>
                    </div>
                </div>
                <div id="col-checkboxes-wl-pitcher" class="col-checkbox-grid"></div>
            </div>
        </div>

        <!-- Watchlist controls -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;flex-wrap:wrap;">
            <select id="wl-avail-filter" onchange="renderWatchlist()" style="padding:5px 10px;border-radius:6px;border:1.5px solid #dee2e6;font-size:0.85em;font-family:inherit;cursor:pointer;">
                <option value="all">All players</option>
                <option value="available">Available only</option>
                <option value="drafted">Drafted / Keeper only</option>
            </select>
        </div>

        <!-- Position filter chips -->
        <div class="wl-pos-filter" id="wl-pos-filter">
            <span class="wl-pos-filter-label">Filter:</span>
            <span class="pos-chip chip-all active" onclick="toggleWLPos('all')">All</span>
            <span class="pos-chip chip-sp" onclick="toggleWLPos('PITCHERS')">All P</span>
            <span class="pos-chip" onclick="toggleWLPos('HITTERS')">All H</span>
            <span class="pos-chip" onclick="toggleWLPos('OF')">All OF</span>
            <span class="pos-chip chip-sp" onclick="toggleWLPos('SP')">SP</span>
            <span class="pos-chip chip-rp" onclick="toggleWLPos('RP')">RP</span>
            <span class="pos-chip" onclick="toggleWLPos('C')">C</span>
            <span class="pos-chip" onclick="toggleWLPos('1B')">1B</span>
            <span class="pos-chip" onclick="toggleWLPos('2B')">2B</span>
            <span class="pos-chip" onclick="toggleWLPos('3B')">3B</span>
            <span class="pos-chip" onclick="toggleWLPos('SS')">SS</span>
            <span class="pos-chip" onclick="toggleWLPos('LF')">LF</span>
            <span class="pos-chip" onclick="toggleWLPos('CF')">CF</span>
            <span class="pos-chip" onclick="toggleWLPos('RF')">RF</span>
            <span class="pos-chip" onclick="toggleWLPos('DH')">DH</span>
            <span class="wl-filter-info" id="wl-filter-info"></span>
        </div>

        <div id="watchlist-hitters-wrap">
            <h3 style="font-size:0.85em;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:#495057;margin:10px 0 6px;">Hitters <span id="wl-hitter-count"></span></h3>
            <div class="player-table-wrap" style="overflow-x:auto;">
                <table class="player-table">
                    <thead id="watchlist-hitter-thead"></thead>
                    <tbody id="watchlist-hitter-tbody"></tbody>
                </table>
            </div>
        </div>

        <div id="watchlist-pitchers-wrap" style="margin-top:16px;">
            <h3 style="font-size:0.85em;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:#495057;margin:10px 0 6px;">Pitchers <span id="wl-pitcher-count"></span></h3>
            <div class="player-table-wrap" style="overflow-x:auto;">
                <table class="player-table">
                    <thead id="watchlist-pitcher-thead"></thead>
                    <tbody id="watchlist-pitcher-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Player Search -->
    <div class="full-card">
        <h2>Player Search <span id="player-count-label"></span>
            <button class="btn-col-picker" style="font-size:0.7em;padding:5px 12px;margin-left:10px;" onclick="toggleSearchColPicker('hitter')">‚öô Hitter Cols</button>
            <button class="btn-col-picker" style="font-size:0.7em;padding:5px 12px;" onclick="toggleSearchColPicker('pitcher')">‚öô Pitcher Cols</button>
        </h2>

        <!-- Search position filter chips -->
        <div class="wl-pos-filter" id="search-pos-filter">
            <span class="wl-pos-filter-label">Filter:</span>
            <span class="pos-chip chip-all active" onclick="toggleSearchPos('all')">All</span>
            <span class="pos-chip chip-sp" onclick="toggleSearchPos('PITCHERS')">All P</span>
            <span class="pos-chip" onclick="toggleSearchPos('HITTERS')">All H</span>
            <span class="pos-chip" onclick="toggleSearchPos('OF')">All OF</span>
            <span class="pos-chip chip-sp" onclick="toggleSearchPos('SP')">SP</span>
            <span class="pos-chip chip-rp" onclick="toggleSearchPos('RP')">RP</span>
            <span class="pos-chip" onclick="toggleSearchPos('C')">C</span>
            <span class="pos-chip" onclick="toggleSearchPos('1B')">1B</span>
            <span class="pos-chip" onclick="toggleSearchPos('2B')">2B</span>
            <span class="pos-chip" onclick="toggleSearchPos('3B')">3B</span>
            <span class="pos-chip" onclick="toggleSearchPos('SS')">SS</span>
            <span class="pos-chip" onclick="toggleSearchPos('LF')">LF</span>
            <span class="pos-chip" onclick="toggleSearchPos('CF')">CF</span>
            <span class="pos-chip" onclick="toggleSearchPos('RF')">RF</span>
            <span class="pos-chip" onclick="toggleSearchPos('DH')">DH</span>
            <span class="wl-filter-info" id="search-filter-info"></span>
        </div>
        <div class="search-controls" style="margin-top:6px;">
            <input type="text" id="search" placeholder="Search by name‚Ä¶">
            <select id="avail-filter">
                <option value="available">Available only</option>
                <option value="all">All players</option>
                <option value="dnw">Do Not Want only</option>
            </select>
            <button class="btn btn-col-picker" id="btn-rankings" onclick="toggleRankingsPanel()" style="background:#1e3c72;color:white;">üìä Rankings</button>
        </div>

        <!-- Search hitter col picker -->
        <div id="col-picker-search-hitter" style="display:none;">
            <div class="col-picker-inner">
                <div class="col-picker-header">
                    <span>Search Hitter Columns</span>
                    <div style="display:flex;gap:8px;">
                        <button class="btn-tiny" onclick="selectAllSearchCols('hitter')">All</button>
                        <button class="btn-tiny" onclick="selectNoneSearchCols('hitter')">None</button>
                        <button class="btn-tiny" id="search-reorder-btn-hitter" onclick="toggleSearchReorder('hitter')" style="background:#e8eef8;border-color:#1e3c72;color:#1e3c72;">&#8597; Reorder</button>
                        <button class="btn-tiny btn-save" onclick="saveColPrefs()">&#128190; Save</button>
                    </div>
                </div>
                <div id="col-checkboxes-search-hitter" class="col-checkbox-grid"></div>
            </div>
        </div>

        <!-- Search pitcher col picker -->
        <div id="col-picker-search-pitcher" style="display:none;">
            <div class="col-picker-inner">
                <div class="col-picker-header">
                    <span>Search Pitcher Columns</span>
                    <div style="display:flex;gap:8px;">
                        <button class="btn-tiny" onclick="selectAllSearchCols('pitcher')">All</button>
                        <button class="btn-tiny" onclick="selectNoneSearchCols('pitcher')">None</button>
                        <button class="btn-tiny" id="search-reorder-btn-pitcher" onclick="toggleSearchReorder('pitcher')" style="background:#e8eef8;border-color:#1e3c72;color:#1e3c72;">&#8597; Reorder</button>
                        <button class="btn-tiny btn-save" onclick="saveColPrefs()">&#128190; Save</button>
                    </div>
                </div>
                <div id="col-checkboxes-search-pitcher" class="col-checkbox-grid"></div>
            </div>
        </div>

                <!-- Rankings Panel -->
        <div id="rankings-panel" style="display:none;">
            <div class="rankings-tabs">
                <button class="rtab rtab-active" onclick="switchRankingsTab(0)">Hitter 1</button>
                <button class="rtab" onclick="switchRankingsTab(1)">Hitter 2</button>
                <button class="rtab" onclick="switchRankingsTab(2)">Hitter 3</button>
                <button class="rtab" onclick="switchRankingsTab(3)">Pitcher 1</button>
                <button class="rtab" onclick="switchRankingsTab(4)">Pitcher 2</button>
                <button class="rtab" onclick="switchRankingsTab(5)">Pitcher 3</button>
                <span class="rtab-hint">Import up to 3 hitter + 3 pitcher ranking lists</span>
            </div>
            <div id="rankings-tab-0" class="rankings-tab-pane">
                <div class="rankings-list-header">
                    <input class="rankings-list-name" id="rname-0" type="text" value="Hitter Rank 1"
                           onchange="saveRankingsName(0)">
                    <div id="rlist-loaded-0" class="rlist-loaded" style="display:none;">
                        <span id="rlist-count-0"></span>
                        <button class="btn-tiny" style="background:#dc3545;color:white;padding:4px 8px;" onclick="clearRankingsList(0)">&#10003; Clear</button>
                        <button class="btn-tiny" style="background:#28a745;color:white;padding:4px 8px;" onclick="applyRankingsList(0)">&#10004; Import</button>
                    </div>
                </div>
                <div class="rankings-status" id="rlist-status-0"></div>
                <div class="rankings-drop-zone" id="rlist-dz-0"
                     onclick="document.getElementById('rlist-file-0').click()"
                     ondragover="event.preventDefault(); event.currentTarget.classList.add('drag-over');"
                     ondragleave="event.currentTarget.classList.remove('drag-over');"
                     ondrop="handleRankingsDrop(event, 0)">
                    <div class="dz-icon">&#128206;</div>
                    <div class="dz-text">Drop rankings file here or click to browse</div>
                    <span class="dz-sub">.xlsx or .csv &mdash; needs First Name, Last Name, and a rank/score column</span>
                </div>
                <input type="file" id="rlist-file-0" accept=".xlsx,.xls,.csv" onchange="handleRankingsFile(this.files[0],0)">
                <div id="rlist-map-0" class="col-map-section" style="display:none;">
                    <div class="col-map-header">Column Mapping</div>
                    <div class="col-map-grid">
                        <label>First Name Column:</label>
                        <select id="rmap-first-0"></select>
                        <label>Last Name Column:</label>
                        <select id="rmap-last-0"></select>
                        <label>Rank/Score Column:</label>
                        <select id="rmap-rank-0"></select>
                        <label>Sort Order:</label>
                        <select id="rmap-order-0">
                            <option value="asc">Ascending (1,2,3...)</option>
                            <option value="desc">Descending (100,99,98...)</option>
                        </select>
                    </div>
                    <div class="col-map-actions">
                        <button class="btn btn-small" onclick="confirmRankingsImport(0)">Confirm Import</button>
                        <button class="btn btn-ghost btn-small" onclick="cancelRankingsImport(0)">Cancel</button>
                    </div>
                </div>
            </div>
            <div id="rankings-tab-1" class="rankings-tab-pane" style="display:none;">
                <div class="rankings-list-header">
                    <input class="rankings-list-name" id="rname-1" type="text" value="Hitter Rank 2"
                           onchange="saveRankingsName(1)">
                    <div id="rlist-loaded-1" class="rlist-loaded" style="display:none;">
                        <span id="rlist-count-1"></span>
                        <button class="btn-tiny" style="background:#dc3545;color:white;padding:4px 8px;" onclick="clearRankingsList(1)">&#10003; Clear</button>
                        <button class="btn-tiny" style="background:#28a745;color:white;padding:4px 8px;" onclick="applyRankingsList(1)">&#10004; Import</button>
                    </div>
                </div>
                <div class="rankings-status" id="rlist-status-1"></div>
                <div class="rankings-drop-zone" id="rlist-dz-1"
                     onclick="document.getElementById('rlist-file-1').click()"
                     ondragover="event.preventDefault(); event.currentTarget.classList.add('drag-over');"
                     ondragleave="event.currentTarget.classList.remove('drag-over');"
                     ondrop="handleRankingsDrop(event, 1)">
                    <div class="dz-icon">&#128206;</div>
                    <div class="dz-text">Drop rankings file here or click to browse</div>
                    <span class="dz-sub">.xlsx or .csv &mdash; needs First Name, Last Name, and a rank/score column</span>
                </div>
                <input type="file" id="rlist-file-1" accept=".xlsx,.xls,.csv" onchange="handleRankingsFile(this.files[0],1)">
                <div id="rlist-map-1" class="col-map-section" style="display:none;">
                    <div class="col-map-header">Column Mapping</div>
                    <div class="col-map-grid">
                        <label>First Name Column:</label>
                        <select id="rmap-first-1"></select>
                        <label>Last Name Column:</label>
                        <select id="rmap-last-1"></select>
                        <label>Rank/Score Column:</label>
                        <select id="rmap-rank-1"></select>
                        <label>Sort Order:</label>
                        <select id="rmap-order-1">
                            <option value="asc">Ascending (1,2,3...)</option>
                            <option value="desc">Descending (100,99,98...)</option>
                        </select>
                    </div>
                    <div class="col-map-actions">
                        <button class="btn btn-small" onclick="confirmRankingsImport(1)">Confirm Import</button>
                        <button class="btn btn-ghost btn-small" onclick="cancelRankingsImport(1)">Cancel</button>
                    </div>
                </div>
            </div>
            <div id="rankings-tab-2" class="rankings-tab-pane" style="display:none;">
                <div class="rankings-list-header">
                    <input class="rankings-list-name" id="rname-2" type="text" value="Hitter Rank 3"
                           onchange="saveRankingsName(2)">
                    <div id="rlist-loaded-2" class="rlist-loaded" style="display:none;">
                        <span id="rlist-count-2"></span>
                        <button class="btn-tiny" style="background:#dc3545;color:white;padding:4px 8px;" onclick="clearRankingsList(2)">&#10003; Clear</button>
                        <button class="btn-tiny" style="background:#28a745;color:white;padding:4px 8px;" onclick="applyRankingsList(2)">&#10004; Import</button>
                    </div>
                </div>
                <div class="rankings-status" id="rlist-status-2"></div>
                <div class="rankings-drop-zone" id="rlist-dz-2"
                     onclick="document.getElementById('rlist-file-2').click()"
                     ondragover="event.preventDefault(); event.currentTarget.classList.add('drag-over');"
                     ondragleave="event.currentTarget.classList.remove('drag-over');"
                     ondrop="handleRankingsDrop(event, 2)">
                    <div class="dz-icon">&#128206;</div>
                    <div class="dz-text">Drop rankings file here or click to browse</div>
                    <span class="dz-sub">.xlsx or .csv &mdash; needs First Name, Last Name, and a rank/score column</span>
                </div>
                <input type="file" id="rlist-file-2" accept=".xlsx,.xls,.csv" onchange="handleRankingsFile(this.files[0],2)">
                <div id="rlist-map-2" class="col-map-section" style="display:none;">
                    <div class="col-map-header">Column Mapping</div>
                    <div class="col-map-grid">
                        <label>First Name Column:</label>
                        <select id="rmap-first-2"></select>
                        <label>Last Name Column:</label>
                        <select id="rmap-last-2"></select>
                        <label>Rank/Score Column:</label>
                        <select id="rmap-rank-2"></select>
                        <label>Sort Order:</label>
                        <select id="rmap-order-2">
                            <option value="asc">Ascending (1,2,3...)</option>
                            <option value="desc">Descending (100,99,98...)</option>
                        </select>
                    </div>
                    <div class="col-map-actions">
                        <button class="btn btn-small" onclick="confirmRankingsImport(2)">Confirm Import</button>
                        <button class="btn btn-ghost btn-small" onclick="cancelRankingsImport(2)">Cancel</button>
                    </div>
                </div>
            </div>
            <div id="rankings-tab-3" class="rankings-tab-pane" style="display:none;">
                <div class="rankings-list-header">
                    <input class="rankings-list-name" id="rname-3" type="text" value="Pitcher Rank 1"
                           onchange="saveRankingsName(3)">
                    <div id="rlist-loaded-3" class="rlist-loaded" style="display:none;">
                        <span id="rlist-count-3"></span>
                        <button class="btn-tiny" style="background:#dc3545;color:white;padding:4px 8px;" onclick="clearRankingsList(3)">&#10003; Clear</button>
                        <button class="btn-tiny" style="background:#28a745;color:white;padding:4px 8px;" onclick="applyRankingsList(3)">&#10004; Import</button>
                    </div>
                </div>
                <div class="rankings-status" id="rlist-status-3"></div>
                <div class="rankings-drop-zone" id="rlist-dz-3"
                     onclick="document.getElementById('rlist-file-3').click()"
                     ondragover="event.preventDefault(); event.currentTarget.classList.add('drag-over');"
                     ondragleave="event.currentTarget.classList.remove('drag-over');"
                     ondrop="handleRankingsDrop(event, 3)">
                    <div class="dz-icon">&#128206;</div>
                    <div class="dz-text">Drop rankings file here or click to browse</div>
                    <span class="dz-sub">.xlsx or .csv &mdash; needs First Name, Last Name, and a rank/score column</span>
                </div>
                <input type="file" id="rlist-file-3" accept=".xlsx,.xls,.csv" onchange="handleRankingsFile(this.files[0],3)">
                <div id="rlist-map-3" class="col-map-section" style="display:none;">
                    <div class="col-map-header">Column Mapping</div>
                    <div class="col-map-grid">
                        <label>First Name Column:</label>
                        <select id="rmap-first-3"></select>
                        <label>Last Name Column:</label>
                        <select id="rmap-last-3"></select>
                        <label>Rank/Score Column:</label>
                        <select id="rmap-rank-3"></select>
                        <label>Sort Order:</label>
                        <select id="rmap-order-3">
                            <option value="asc">Ascending (1,2,3...)</option>
                            <option value="desc">Descending (100,99,98...)</option>
                        </select>
                    </div>
                    <div class="col-map-actions">
                        <button class="btn btn-small" onclick="confirmRankingsImport(3)">Confirm Import</button>
                        <button class="btn btn-ghost btn-small" onclick="cancelRankingsImport(3)">Cancel</button>
                    </div>
                </div>
            </div>
            <div id="rankings-tab-4" class="rankings-tab-pane" style="display:none;">
                <div class="rankings-list-header">
                    <input class="rankings-list-name" id="rname-4" type="text" value="Pitcher Rank 2"
                           onchange="saveRankingsName(4)">
                    <div id="rlist-loaded-4" class="rlist-loaded" style="display:none;">
                        <span id="rlist-count-4"></span>
                        <button class="btn-tiny" style="background:#dc3545;color:white;padding:4px 8px;" onclick="clearRankingsList(4)">&#10003; Clear</button>
                        <button class="btn-tiny" style="background:#28a745;color:white;padding:4px 8px;" onclick="applyRankingsList(4)">&#10004; Import</button>
                    </div>
                </div>
                <div class="rankings-status" id="rlist-status-4"></div>
                <div class="rankings-drop-zone" id="rlist-dz-4"
                     onclick="document.getElementById('rlist-file-4').click()"
                     ondragover="event.preventDefault(); event.currentTarget.classList.add('drag-over');"
                     ondragleave="event.currentTarget.classList.remove('drag-over');"
                     ondrop="handleRankingsDrop(event, 4)">
                    <div class="dz-icon">&#128206;</div>
                    <div class="dz-text">Drop rankings file here or click to browse</div>
                    <span class="dz-sub">.xlsx or .csv &mdash; needs First Name, Last Name, and a rank/score column</span>
                </div>
                <input type="file" id="rlist-file-4" accept=".xlsx,.xls,.csv" onchange="handleRankingsFile(this.files[0],4)">
                <div id="rlist-map-4" class="col-map-section" style="display:none;">
                    <div class="col-map-header">Column Mapping</div>
                    <div class="col-map-grid">
                        <label>First Name Column:</label>
                        <select id="rmap-first-4"></select>
                        <label>Last Name Column:</label>
                        <select id="rmap-last-4"></select>
                        <label>Rank/Score Column:</label>
                        <select id="rmap-rank-4"></select>
                        <label>Sort Order:</label>
                        <select id="rmap-order-4">
                            <option value="asc">Ascending (1,2,3...)</option>
                            <option value="desc">Descending (100,99,98...)</option>
                        </select>
                    </div>
                    <div class="col-map-actions">
                        <button class="btn btn-small" onclick="confirmRankingsImport(4)">Confirm Import</button>
                        <button class="btn btn-ghost btn-small" onclick="cancelRankingsImport(4)">Cancel</button>
                    </div>
                </div>
            </div>
            <div id="rankings-tab-5" class="rankings-tab-pane" style="display:none;">
                <div class="rankings-list-header">
                    <input class="rankings-list-name" id="rname-5" type="text" value="Pitcher Rank 3"
                           onchange="saveRankingsName(5)">
                    <div id="rlist-loaded-5" class="rlist-loaded" style="display:none;">
                        <span id="rlist-count-5"></span>
                        <button class="btn-tiny" style="background:#dc3545;color:white;padding:4px 8px;" onclick="clearRankingsList(5)">&#10003; Clear</button>
                        <button class="btn-tiny" style="background:#28a745;color:white;padding:4px 8px;" onclick="applyRankingsList(5)">&#10004; Import</button>
                    </div>
                </div>
                <div class="rankings-status" id="rlist-status-5"></div>
                <div class="rankings-drop-zone" id="rlist-dz-5"
                     onclick="document.getElementById('rlist-file-5').click()"
                     ondragover="event.preventDefault(); event.currentTarget.classList.add('drag-over');"
                     ondragleave="event.currentTarget.classList.remove('drag-over');"
                     ondrop="handleRankingsDrop(event, 5)">
                    <div class="dz-icon">&#128206;</div>
                    <div class="dz-text">Drop rankings file here or click to browse</div>
                    <span class="dz-sub">.xlsx or .csv &mdash; needs First Name, Last Name, and a rank/score column</span>
                </div>
                <input type="file" id="rlist-file-5" accept=".xlsx,.xls,.csv" onchange="handleRankingsFile(this.files[0],5)">
                <div id="rlist-map-5" class="col-map-section" style="display:none;">
                    <div class="col-map-header">Column Mapping</div>
                    <div class="col-map-grid">
                        <label>First Name Column:</label>
                        <select id="rmap-first-5"></select>
                        <label>Last Name Column:</label>
                        <select id="rmap-last-5"></select>
                        <label>Rank/Score Column:</label>
                        <select id="rmap-rank-5"></select>
                        <label>Sort Order:</label>
                        <select id="rmap-order-5">
                            <option value="asc">Ascending (1,2,3...)</option>
                            <option value="desc">Descending (100,99,98...)</option>
                        </select>
                    </div>
                    <div class="col-map-actions">
                        <button class="btn btn-small" onclick="confirmRankingsImport(5)">Confirm Import</button>
                        <button class="btn btn-ghost btn-small" onclick="cancelRankingsImport(5)">Cancel</button>
                    </div>
                </div>
            </div>
            <div style="margin-top:10px;font-size:0.8em;color:#6c757d;border-top:1px solid #dee2e6;padding-top:8px;">
                <a href="hitter_rankings_template.csv" download style="color:#1e3c72;">‚Üì Hitter Template</a>
                <span style="color:#6c757d;margin:0 8px;">|</span>
                <a href="pitcher_rankings_template.csv" download style="color:#1e3c72;">‚Üì Pitcher Template</a>
            </div>
        </div>

        <div id="search-hitters-wrap">
            <h3 style="font-size:0.85em;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:#495057;margin:10px 0 6px;">Hitters <span id="search-hitter-count"></span></h3>
            <div class="player-table-wrap" style="overflow-x:auto;">
                <table class="player-table">
                    <thead id="search-hitter-thead"></thead>
                    <tbody id="search-hitter-tbody"></tbody>
                </table>
            </div>
        </div>

        <div id="search-pitchers-wrap" style="margin-top:16px;">
            <h3 style="font-size:0.85em;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:#495057;margin:10px 0 6px;">Pitchers <span id="search-pitcher-count"></span></h3>
            <div class="player-table-wrap" style="overflow-x:auto;">
                <table class="player-table">
                    <thead id="search-pitcher-thead"></thead>
                    <tbody id="search-pitcher-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
    </div>
    </div>
</div>

<script>

        const TEAMS = ['PHI','SEA','BAL','CWS','PIT','NYM','KC','BOS','STL','CIN',
                       'OAK','LA','CHC','DET','CLE','HOU','SF','TEX','ATL','NY'];
        const REQUIREMENTS = { C: 3, SP: 8, RP: 8 };
        const POS_LABELS = { C:'C', SP:'SP', RP:'RP', '1b':'1B', '2b':'2B', '3b':'3B', ss:'SS', lf:'LF', cf:'CF', rf:'RF', dh:'DH' };
        const ALL_POS = ['C','SP','RP','1b','2b','3b','ss','lf','cf','rf','dh'];
        const NUM_ROUNDS = 30;

        let players = [];
        let draftedPlayers = [];
        let currentPickIndex = 0;

        function getPlayerPosition(p) { return (p.P || 'UTIL'); }

        function getEligiblePositions(p) {
            if (p.eligible_positions && p.eligible_positions.length)
                return p.eligible_positions.map(function(x){ return x.toLowerCase(); });
            return [getPlayerPosition(p).toLowerCase()];
        }
        function getPosDisplay(p) {
            var elig = getEligiblePositions(p);
            return elig.map(function(x){ return x.toUpperCase(); }).join('/');
        }

        function gradeColor(val) {
            if (!val) return '#999';
            var g = String(val).split('/')[0];
            return {Ex:'#155724', Vg:'#1a6830', Av:'#7d6608', Fr:'#842029', Pr:'#6c1b22'}[g] || '#333';
        }
        function gradeBg(val) {
            if (!val) return 'transparent';
            var g = String(val).split('/')[0];
            return {Ex:'#d1e7dd', Vg:'#d1e7dd', Av:'#fff3cd', Fr:'#f8d7da', Pr:'#f8d7da'}[g] || 'transparent';
        }
        function fmtGrade(val) {
            if (!val) return '‚Äî';
            return String(val).replace('/', ' / ');
        }

        function loadDraftState() {
            const saved = localStorage.getItem('busterLeagueDraft');
            if (saved) {
                const d = JSON.parse(saved);
                draftedPlayers = d.draftedPlayers || [];
                currentPickIndex = d.currentPickIndex || 0;
            }
        }

        // Unsanitize data from Firebase
        function unsanitizeFromFirebase(obj) {
            if (obj === null || obj === undefined) return obj;
            if (typeof obj !== 'object') return obj;
            if (Array.isArray(obj)) return obj.map(unsanitizeFromFirebase);
            
            const unsanitized = {};
            const keyMap = {
                'H_9': 'H/9', 'K_9': 'K/9', 'BB_9': 'BB/9', 'HR_9': 'HR/9'
            };
            
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    const originalKey = keyMap[key] || key;
                    unsanitized[originalKey] = unsanitizeFromFirebase(obj[key]);
                }
            }
            return unsanitized;
        }

        function getMyTeam() {
            return localStorage.getItem('busterLeagueTeam') || '';
        }

        function logout() {
            localStorage.removeItem('busterLeagueTeam');
            window.location.href = 'login.html';
        }

        function fmt(val, dec) {
            if (val == null || val === '') return '‚Äî';
            const n = parseFloat(val);
            if (isNaN(n)) return '‚Äî';
            return dec != null ? n.toFixed(dec) : Math.round(n);
        }

        function getAvailability(p) {
            if (p.Team) return 'keeper';
            const found = draftedPlayers.find(function(d) {
                return d.player.First === p.First && d.player.Last === p.Last && d.player.Age === p.Age;
            });
            return found ? 'drafted' : 'available';
        }

        function isPitcher(p) {
            const pos = getPlayerPosition(p).toUpperCase();
            return pos === 'SP' || pos === 'RP';
        }
        // Watchlist
        function watchKey(p) { return p.First + '|' + p.Last + '|' + p.Age; }

        function getWatchlist() {
            try { return JSON.parse(localStorage.getItem('watchlist_' + getMyTeam()) || '[]'); }
            catch(e) { return []; }
        }

        function isWatched(p) { return getWatchlist().indexOf(watchKey(p)) !== -1; }

        function toggleWatch(key) {
            var wl = getWatchlist();
            var idx = wl.indexOf(key);
            if (idx !== -1) { wl.splice(idx, 1); } else { wl.push(key); }
            
            // Save to localStorage as backup
            localStorage.setItem('watchlist_' + getMyTeam(), JSON.stringify(wl));
            
            // Save to Firebase for real-time sync
            const team = getMyTeam();
            if (window.firebaseInitialized && team) {
                window.firebaseSet(window.firebaseRef(window.firebaseDB, 'watchlists/' + team), wl).catch(error => {
                    console.error('Firebase save error:', error);
                });
            }
            
            renderAll();
        }

        // Use event delegation for watch buttons - avoids inline onclick quote issues
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('.watch-btn');
            if (btn) { toggleWatch(btn.getAttribute('data-key')); }
            var dbtn = e.target.closest('.dnw-btn');
            if (dbtn) { toggleDNW(dbtn.getAttribute('data-dnw-key')); }
        });

        function watchBtn(p) {
            var watched = isWatched(p);
            var key = watchKey(p);
            var cls = 'watch-btn' + (watched ? ' watching' : '');
            var label = watched ? '‚≠ê Watching' : '+ Watch';
            return '<button class="' + cls + '" data-key="' + key + '">' + label + '</button>';
        }

        // Render: Header
        function renderHeader() {
            var team = getMyTeam();
            document.getElementById('team-heading').textContent = '‚öæ ' + team + ' Dashboard';
        }

        // Render: Roster




        function getRosterRows() {
            var team = getMyTeam().toUpperCase();
            var keepers = players.filter(function(p) { return (p.Team || '').toUpperCase() === team; });
            var drafted = draftedPlayers.filter(function(d) { return (d.team || '').toUpperCase() === team; });
            return keepers.map(function(p) { return { player: p, type: 'keeper' }; })
                .concat(drafted.map(function(d) { return { player: d.player, type: 'drafted' }; }));
        }

        function renderStatTable(theadId, tbodyId, rows, cols, emptyLabel) {
            var thead = document.getElementById(theadId);
            var tbody = document.getElementById(tbodyId);
            if (!thead || !tbody) return;

            var type    = theadId.indexOf('hitter') !== -1 ? 'hitter' : 'pitcher';
            var hidden  = type === 'hitter' ? hiddenRosterHitterCols : hiddenRosterPitcherCols;
            var visCols = getRosterOrderedCols(type, hidden);
            // Prepend always-visible columns
            var always = cols.filter(function(c) { return c.key === 'name' || c.key === 'P'; });
            visCols = always.concat(visCols);

            thead.innerHTML = '<tr>' + visCols.map(function(c) {
                return '<th>' + c.label + '</th>';
            }).join('') + '</tr>';

            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="' + visCols.length + '" style="text-align:center;color:#6c757d;padding:20px;">No ' + emptyLabel + ' on roster yet</td></tr>';
                return;
            }

            tbody.innerHTML = rows.map(function(r) {
                var p = r.player;
                var pos = getPlayerPosition(p);
                var cells = visCols.map(function(c) {
                    if (c.key === 'name') {
                        var badge = r.type === 'keeper'
                            ? ' <span class="k-badge">K</span>'
                            : ' <span class="d-badge">D</span>';
                        return '<td style="font-weight:600">' + p.First + ' ' + p.Last + badge + '</td>';
                    }
                    if (c.key === 'P') return '<td><span class="pos-badge">' + getPosDisplay(p) + '</span></td>';
                    if (c.key === 'Age')    return '<td>' + (p.Age || '‚Äî') + '</td>';
                    if (c.key === 'T')      return '<td>' + (p.T || '‚Äî') + '</td>';
                    if (c.key === 'B')      return '<td>' + (p.B || '‚Äî') + '</td>';
                    if (c.key === 'Injury') return '<td>' + (p.Injury || '‚Äî') + '</td>';
                    if (c.key === 'SDur')   return '<td>' + (p.SDur || '‚Äî') + '</td>';
                    if (c.key === 'RDur')   return '<td>' + (p.RDur || '‚Äî') + '</td>';
                    if (c.frating) {
                        var rv = p[c.key];
                        if (!rv) return '<td style="color:#ccc">‚Äî</td>';
                        return '<td style="background:' + gradeBg(rv) + ';color:' + gradeColor(rv) + ';font-weight:600;white-space:nowrap;font-size:0.82em">' + fmtGrade(rv) + '</td>';
                    }
                    if (c.frating) {
                        var rv = p[c.key];
                        if (!rv) return '<td style="color:#ccc">‚Äî</td>';
                        return '<td style="background:' + gradeBg(rv) + ';color:' + gradeColor(rv) + ';font-weight:600;white-space:nowrap;font-size:0.85em">' + fmtGrade(rv) + '</td>';
                    }
                    var val = fmt(p[c.key], c.dec);
                    return '<td style="color:' + (val === '‚Äî' ? '#ccc' : '#333') + '">' + val + '</td>';
                }).join('');
                return '<tr>' + cells + '</tr>';
            }).join('');
        }

        function toggleRosterPosHitter(pos) {
            if (rosterActivePosFiltersHitter.has(pos)) rosterActivePosFiltersHitter.delete(pos);
            else rosterActivePosFiltersHitter.add(pos);
            updateRosterPosChipsHitter();
            renderRoster();
        }

        function toggleRosterPosPitcher(pos) {
            if (rosterActivePosFiltersPitcher.has(pos)) rosterActivePosFiltersPitcher.delete(pos);
            else rosterActivePosFiltersPitcher.add(pos);
            updateRosterPosChipsPitcher();
            renderRoster();
        }

        function updateRosterPosChipsHitter() {
            var chips = ['All','C','1B','2B','3B','SS','LF','CF','RF','DH'];
            var html = '<span class="wl-filter-info" id="roster-filter-info-hitter"></span>';
            chips.forEach(function(pos) {
                var active = rosterActivePosFiltersHitter.has(pos);
                html += '<button class="pos-chip' + (active ? ' active' : '') + '" onclick="toggleRosterPosHitter(\'' + pos + '\')">' + pos + '</button>';
            });
            document.getElementById('roster-pos-filter-hitter').innerHTML = html;
            
            if (rosterActivePosFiltersHitter.size) {
                document.getElementById('roster-filter-info-hitter').textContent = 'Showing: ' + Array.from(rosterActivePosFiltersHitter).join(', ');
            }
        }

        function updateRosterPosChipsPitcher() {
            var chips = ['All','SP','RP'];
            var html = '<span class="wl-filter-info" id="roster-filter-info-pitcher"></span>';
            chips.forEach(function(pos) {
                var active = rosterActivePosFiltersPitcher.has(pos);
                html += '<button class="pos-chip' + (active ? ' active' : '') + '" onclick="toggleRosterPosPitcher(\'' + pos + '\')">' + pos + '</button>';
            });
            document.getElementById('roster-pos-filter-pitcher').innerHTML = html;
            
            if (rosterActivePosFiltersPitcher.size) {
                document.getElementById('roster-filter-info-pitcher').textContent = 'Showing: ' + Array.from(rosterActivePosFiltersPitcher).join(', ');
            }
        }

        function rosterPlayerMatchesFilterHitter(p) {
            if (!rosterActivePosFiltersHitter.size) return true;
            if (rosterActivePosFiltersHitter.has('All')) return true;
            
            var eligible = getEligiblePositions(p);
            return eligible.some(function(pos) {
                return rosterActivePosFiltersHitter.has(pos.toUpperCase());
            });
        }

        function rosterPlayerMatchesFilterPitcher(p) {
            if (!rosterActivePosFiltersPitcher.size) return true;
            if (rosterActivePosFiltersPitcher.has('All')) return true;
            
            var pos = (p.P || '').toUpperCase();
            return rosterActivePosFiltersPitcher.has(pos);
        }

        function renderRoster() {
            var rows = getRosterRows();

            var isP = function(r) {
                var pos = (getPlayerPosition(r.player) || '').toUpperCase();
                return pos === 'SP' || pos === 'RP';
            };
            var allHitters  = rows.filter(function(r) { return !isP(r); });
            var allPitchers = rows.filter(isP);
            
            // Apply position filters
            var hitters = allHitters.filter(function(r) { return rosterPlayerMatchesFilterHitter(r.player); });
            var pitchers = allPitchers.filter(function(r) { return rosterPlayerMatchesFilterPitcher(r.player); });
            
            // Update filter chips
            updateRosterPosChipsHitter();
            updateRosterPosChipsPitcher();

            document.getElementById('roster-count-label') &&
                (document.getElementById('roster-count-label').textContent = rows.length + ' players');
            var hitterLabel = hitters.length === allHitters.length ? hitters.length + ' players' : hitters.length + ' / ' + allHitters.length + ' players';
            var pitcherLabel = pitchers.length === allPitchers.length ? pitchers.length + ' players' : pitchers.length + ' / ' + allPitchers.length + ' players';
            document.getElementById('hitter-count-label').textContent = hitterLabel;
            document.getElementById('pitcher-count-label').textContent = pitcherLabel;

            renderStatTable('hitter-roster-thead',  'hitter-roster-tbody',  hitters,  HITTER_COLS,  'hitters');
            renderStatTable('pitcher-roster-thead', 'pitcher-roster-tbody', pitchers, PITCHER_COLS, 'pitchers');

            // Position needs
            var posCounts = {};
            ALL_POS.forEach(function(p) { posCounts[p.toUpperCase()] = 0; });
            rows.forEach(function(r) {
                getEligiblePositions(r.player).forEach(function(ep) {
                    var key = ep.toUpperCase();
                    if (posCounts[key] !== undefined) posCounts[key]++;
                });
            });
            document.getElementById('needs-grid').innerHTML = Object.keys(REQUIREMENTS).map(function(pos) {
                var req = REQUIREMENTS[pos];
                var have = posCounts[pos] || 0;
                var rem = req - have;
                var cls = rem <= 0 ? 'complete' : rem === 1 ? 'close' : 'needed';
                var label = POS_LABELS[pos] || pos;
                return '<div class="need-item ' + cls + '">'
                    + '<div>'
                    + '<div class="need-pos">' + label + '</div>'
                    + '<div class="need-remaining">' + (rem <= 0 ? '‚úî Filled' : 'Need ' + rem + ' more') + '</div>'
                    + '</div>'
                    + '<div class="need-count ' + cls + '">' + have + '/' + req + '</div>'
                    + '</div>';
            }).join('');

            var breakdown = document.getElementById('pos-breakdown');
            if (breakdown) {
                breakdown.innerHTML = ALL_POS.map(function(pos) {
                    var key = pos.toUpperCase();
                    var count = posCounts[key] || 0;
                    var style = count < 2 ? ' style="color:#dc3545;font-weight:700;"' : '';
                    return '<div class="pos-box">'
                        + '<div class="pos-box-label">' + (POS_LABELS[pos] || pos) + '</div>'
                        + '<div class="pos-box-count"' + style + '>' + count + '</div>'
                        + '</div>';
                }).join('');
            }
        }
        // Render: My Picks
        function renderMyPicks() {
            var team = getMyTeam();
            var n = TEAMS.length;
            var slots = [];
            for (var round = 1; round <= NUM_ROUNDS; round++) {
                for (var i = 0; i < n; i++) {
                    var t = round % 2 === 1 ? TEAMS[i] : TEAMS[n-1-i];
                    if (t === team) slots.push({ round: round, overall: (round-1)*n + i + 1 });
                }
            }
            var byPick = {};
            draftedPlayers.filter(function(d) { return d.team === team; })
                .forEach(function(d) { byPick[d.pickNumber] = d; });

            document.getElementById('picks-label').textContent =
                Object.keys(byPick).length + ' / ' + slots.length;

            document.getElementById('my-picks-tbody').innerHTML = slots.map(function(slot) {
                var d = byPick[slot.overall];
                if (d) {
                    var pos = getPlayerPosition(d.player);
                    return '<tr><td>Rd ' + slot.round + '</td><td>#' + slot.overall + '</td>'
                        + '<td style="font-weight:600">' + d.player.First + ' ' + d.player.Last + '</td>'
                        + '<td><span class="pos-badge">' + pos.toUpperCase() + '</span></td></tr>';
                }
                return '<tr style="opacity:0.4"><td>Rd ' + slot.round + '</td><td>#' + slot.overall + '</td>'
                    + '<td style="color:#adb5bd;">‚Äî Empty ‚Äî</td><td></td></tr>';
            }).join('');
        }

        // Render: Watchlist
        // Watchlist sort + order state
        var wlSortCol  = null;
        var wlSortDir  = 'asc';
        var wlSortList = 0;
        var wlColOrderHitter  = null;
        var wlColOrderPitcher = null;
        var wlReorderMode     = { hitter: false, pitcher: false };

        function setWLSort(col, listIdx) {
            var li = (listIdx === undefined || listIdx === null) ? -1 : listIdx;
            if (wlSortCol === col && wlSortList === li) {
                wlSortDir = wlSortDir === 'asc' ? 'desc' : 'asc';
            } else { wlSortCol = col; wlSortDir = 'asc'; wlSortList = li; }
            renderWatchlist();
        }

        function getWLOrderedCols(type, hiddenSet) {
            var allCols = type === 'hitter' ? ALL_HITTER_COLS : ALL_PITCHER_COLS;
            var order   = type === 'hitter' ? wlColOrderHitter : wlColOrderPitcher;
            var ordered;
            if (order && order.length) {
                var colMap = {};
                allCols.forEach(function(c) { colMap[c.key] = c; });
                ordered = order.map(function(k) { return colMap[k]; }).filter(Boolean);
                allCols.forEach(function(c) { if (order.indexOf(c.key) === -1) ordered.push(c); });
            } else { ordered = allCols.slice(); }
            return ordered.filter(function(c) { return !hiddenSet.has(c.key); });
        }

        function renderWatchlist() {
            var wl = getWatchlist();
            var totalCount = wl.length;
            var watched = players.filter(function(p) { return wl.indexOf(watchKey(p)) !== -1; });
            var availEl = document.getElementById('wl-avail-filter');
            var availFilter = availEl ? availEl.value : 'all';
            var filtered = watched.filter(wlPlayerMatchesFilter).filter(function(p) {
                if (availFilter === 'available') return getAvailability(p) === 'available' && !isDNW(p);
                if (availFilter === 'drafted')   return getAvailability(p) !== 'available';
                return true;
            });
            var hitters  = filtered.filter(function(p) { return !isPitcher(p); });
            var pitchers = filtered.filter(function(p) { return  isPitcher(p); });
            function sortRows(rows) {
                if (!wlSortCol) return rows;
                return rows.slice().sort(function(a, b) {
                    if (wlSortCol.startsWith('_rank')) {
                        var li = wlSortList;
                        var ar = getPlayerRank(a, li), br = getPlayerRank(b, li);
                        if (ar === null && br === null) return 0;
                        if (ar === null) return 1; if (br === null) return -1;
                        var cmp = rLists[li].order === 'asc' ? ar - br : br - ar;
                        return wlSortDir === 'asc' ? cmp : -cmp;
                    }
                    var av = parseFloat(a[wlSortCol]), bv = parseFloat(b[wlSortCol]);
                    var an = isNaN(av) ? (wlSortDir==='asc'?Infinity:-Infinity) : av;
                    var bn = isNaN(bv) ? (wlSortDir==='asc'?Infinity:-Infinity) : bv;
                    return wlSortDir === 'asc' ? an - bn : bn - an;
                });
            }
            hitters  = sortRows(hitters);
            pitchers = sortRows(pitchers);
            var hCountEl = document.getElementById('wl-hitter-count');
            var pCountEl = document.getElementById('wl-pitcher-count');
            var countEl  = document.getElementById('watchlist-count');
            if (hCountEl) hCountEl.textContent = '(' + hitters.length + ')';
            if (pCountEl) pCountEl.textContent = '(' + pitchers.length + ')';
            if (countEl) {
                var shown = hitters.length + pitchers.length;
                countEl.textContent = (wlActivePosFilters.size > 0 || availFilter !== 'all')
                    ? shown + ' of ' + totalCount + ' players'
                    : totalCount + ' players';
            }
            function renderWLTable(theadId, tbodyId, rows, type, emptyMsg) {
                var thead = document.getElementById(theadId);
                var tbody = document.getElementById(tbodyId);
                if (!thead || !tbody) return;
                var hiddenSet = type === 'hitter' ? hiddenWLHitterCols : hiddenWLPitcherCols;
                var visCols   = getWLOrderedCols(type, hiddenSet);
                visCols.forEach(function(c) {
                    if (c.rankCol !== undefined) c.label = rNames[c.rankCol] || ('Rank ' + (c.rankCol+1));
                });
                thead.innerHTML = '<tr>' + visCols.map(function(c) {
                    var li = c.rankCol;
                    var hasData = li !== undefined && Object.keys(rLists[li].data).length > 0;
                    var sortable = hasData || c.dec !== undefined || c.key === 'Age';
                    var cls = sortable ? 'sortable' : '';
                    var isActive = wlSortCol === c.key && wlSortList === (li !== undefined ? li : -1);
                    if (isActive) cls += (wlSortDir === 'asc' ? ' sort-asc' : ' sort-desc');
                    var onclick = sortable
                        ? ' onclick="setWLSort(\'' + c.key + '\',' + (li !== undefined ? li : 'undefined') + ')"\''
                        : '';
                    return '<th class="' + cls + '"' + onclick + '>' + c.label + '</th>';
                }).join('') + '</tr>';
                if (!rows.length) {
                    tbody.innerHTML = '<tr><td colspan="' + visCols.length + '" class="watchlist-empty">' + emptyMsg + '</td></tr>';
                    return;
                }
                tbody.innerHTML = rows.map(function(p) {
                    var av = getAvailability(p);
                    var isDnw = isDNW(p);
                    var avLabel = isDnw ? dnwBadge()
                        : av === 'available' ? '<span style="color:#28a745;font-weight:700;">Available</span>'
                        : av === 'keeper'    ? '<span style="color:#0c5460;">Keeper</span>'
                        :                     '<span style="color:#6c757d;">Drafted</span>';
                    var cells = visCols.map(function(c) {
                        if (c.key === 'watch')  return '<td>' + watchBtn(p) + '</td>';
                        if (c.key === 'dnw')    return '<td>' + dnwBtn(p) + '</td>';
                        if (c.key === 'name')   return '<td style="font-weight:600;white-space:nowrap">' + p.First + ' ' + p.Last + '</td>';
                        if (c.key === 'P')      return '<td><span class="pos-badge">' + getPosDisplay(p) + '</span></td>';
                        if (c.key === 'status') return '<td>' + avLabel + '</td>';
                        if (c.key === 'Age')    return '<td>' + (p.Age || '‚Äî') + '</td>';
                        if (c.key === 'T')      return '<td>' + (p.T || '‚Äî') + '</td>';
                        if (c.key === 'B')      return '<td>' + (p.B || '‚Äî') + '</td>';
                        if (c.key === 'Injury') return '<td>' + (p.Injury || '‚Äî') + '</td>';
                        if (c.key === 'SDur')   return '<td>' + (p.SDur || '‚Äî') + '</td>';
                        if (c.key === 'RDur')   return '<td>' + (p.RDur || '‚Äî') + '</td>';
                        if (c.rankCol !== undefined) return rankBadge(getPlayerRank(p, c.rankCol), c.rankCol);
                        if (c.frating) {
                            var rv = p[c.key];
                            if (!rv) return '<td style="color:#ccc">‚Äî</td>';
                            return '<td style="background:' + gradeBg(rv) + ';color:' + gradeColor(rv) + ';font-weight:600;white-space:nowrap;font-size:0.82em">' + fmtGrade(rv) + '</td>';
                        }
                        var val = fmt(p[c.key], c.dec);
                        return '<td style="color:' + (val === '‚Äî' ? '#ccc' : '#333') + '">' + val + '</td>';
                    }).join('');
                    return '<tr class="watched">' + cells + '</tr>';
                }).join('');
            }
            renderWLTable('watchlist-hitter-thead',  'watchlist-hitter-tbody',  hitters,  'hitter',  'No hitters on watchlist');
            renderWLTable('watchlist-pitcher-thead', 'watchlist-pitcher-tbody', pitchers, 'pitcher', 'No pitchers on watchlist');
        }

        // Column visibility state
        var hiddenHitterCols    = new Set();
        var hiddenPitcherCols   = new Set();
        var searchColOrderHitter  = null;
        var searchColOrderPitcher = null;
        var searchReorderMode     = { hitter: false, pitcher: false };
        var hiddenWLHitterCols  = new Set();
        var hiddenWLPitcherCols = new Set();

        var PREFS_KEY_H = 'colPrefs_hitter_'  ;
        var PREFS_KEY_P = 'colPrefs_pitcher_' ;

        function colPrefsKeyH() { return 'colPrefs_hitter_'  + getMyTeam(); }
        function colPrefsKeyP() { return 'colPrefs_pitcher_' + getMyTeam(); }

        function loadColPrefs() {
            try {
                var h = localStorage.getItem(colPrefsKeyH());
                var p = localStorage.getItem(colPrefsKeyP());
                hiddenHitterCols  = h ? new Set(JSON.parse(h)) : new Set();
                hiddenPitcherCols = p ? new Set(JSON.parse(p)) : new Set();
                var oh = localStorage.getItem(colPrefsKeyH() + '_order');
                var op = localStorage.getItem(colPrefsKeyP() + '_order');
                searchColOrderHitter  = oh ? JSON.parse(oh) : null;
                searchColOrderPitcher = op ? JSON.parse(op) : null;
            } catch(e) {
                hiddenHitterCols  = new Set();
                hiddenPitcherCols = new Set();
            }
        }

        function saveColPrefs() {
            localStorage.setItem(colPrefsKeyH(), JSON.stringify(Array.from(hiddenHitterCols)));
            localStorage.setItem(colPrefsKeyP(), JSON.stringify(Array.from(hiddenPitcherCols)));
            var oh = colPrefsKeyH() + '_order', op = colPrefsKeyP() + '_order';
            if (searchColOrderHitter)  localStorage.setItem(oh, JSON.stringify(searchColOrderHitter));
            if (searchColOrderPitcher) localStorage.setItem(op, JSON.stringify(searchColOrderPitcher));
            var toast = document.getElementById('save-toast');
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 2000);
        }
        // Search col picker (split hitter/pitcher)
        function toggleSearchColPicker(type) {
            var hPanel = document.getElementById('col-picker-search-hitter');
            var pPanel = document.getElementById('col-picker-search-pitcher');
            if (type === 'hitter') {
                var openH = hPanel.style.display === 'none';
                hPanel.style.display = openH ? '' : 'none';
                if (pPanel) pPanel.style.display = 'none';
                if (openH) buildSearchColCheckboxes('hitter');
            } else {
                var openP = pPanel.style.display === 'none';
                pPanel.style.display = openP ? '' : 'none';
                if (hPanel) hPanel.style.display = 'none';
                if (openP) buildSearchColCheckboxes('pitcher');
            }
        }

        function toggleSearchReorder(type) {
            searchReorderMode[type] = !searchReorderMode[type];
            var btn = document.getElementById('search-reorder-btn-' + type);
            if (btn) {
                btn.style.background = searchReorderMode[type] ? '#1e3c72' : '#e8eef8';
                btn.style.color      = searchReorderMode[type] ? 'white'   : '#1e3c72';
                btn.textContent      = searchReorderMode[type] ? '\u2713 Done' : '\u2195 Reorder';
            }
            buildSearchColCheckboxes(type);
        }

        function getSearchOrderedCols(type, hiddenSet) {
            var allCols = type === 'hitter' ? ALL_HITTER_COLS : ALL_PITCHER_COLS;
            var order   = type === 'hitter' ? searchColOrderHitter : searchColOrderPitcher;
            var ordered;
            if (order && order.length) {
                var colMap = {};
                allCols.forEach(function(c) { colMap[c.key] = c; });
                ordered = order.map(function(k) { return colMap[k]; }).filter(Boolean);
                allCols.forEach(function(c) { if (order.indexOf(c.key) === -1) ordered.push(c); });
            } else { ordered = allCols.slice(); }
            return ordered.filter(function(c) { return !hiddenSet.has(c.key); });
        }

        function buildSearchColCheckboxes(type) {
            var cols    = type === 'hitter' ? ALL_HITTER_COLS  : ALL_PITCHER_COLS;
            var hidden  = type === 'hitter' ? hiddenHitterCols : hiddenPitcherCols;
            var order   = type === 'hitter' ? searchColOrderHitter : searchColOrderPitcher;
            var grid    = document.getElementById('col-checkboxes-search-' + type);
            if (!grid) return;
            var always  = ['watch','dnw','name','P','status'];
            var orderedCols;
            if (order && order.length) {
                var colMap = {};
                cols.forEach(function(c) { colMap[c.key] = c; });
                orderedCols = order.map(function(k) { return colMap[k]; }).filter(Boolean);
                cols.forEach(function(c) { if (order.indexOf(c.key) === -1) orderedCols.push(c); });
            } else { orderedCols = cols.slice(); }
            var showCols = orderedCols.filter(function(c) { return always.indexOf(c.key) === -1; });
            showCols.forEach(function(c) {
                if (c.rankCol !== undefined) c.label = rNames[c.rankCol] || ('Rank ' + (c.rankCol+1));
            });
            if (searchReorderMode[type]) {
                grid.className = 'col-order-grid';
                grid.innerHTML = showCols.map(function(c) {
                    var isHid = hidden.has(c.key);
                    return '<div class="col-order-chip' + (isHid ? ' hidden-col' : '') + '" draggable="true"'
                        + ' data-key="' + c.key + '" data-type="' + type + '"'
                        + ' ondragstart="searchDragStart(event)" ondragover="searchDragOver(event)"'
                        + ' ondrop="searchDrop(event)" ondragleave="this.classList.remove(\'drag-over\')">' 
                        + '<span class="drag-handle">&#9776;</span>'
                        + '<span>' + c.label + '</span>'
                        + '<span class="col-eye" onclick="toggleSearchColVisibility(\'' + c.key + '\',\'' + type + '\')">'  
                        + (isHid ? '&#128065;&#65039;' : '&#128065;') + '</span>'
                        + '</div>';
                }).join('');
            } else {
                grid.className = 'col-checkbox-grid';
                grid.innerHTML = showCols.filter(function(c) {
                    return always.indexOf(c.key) === -1;
                }).map(function(c) {
                    var checked = !hidden.has(c.key);
                    return '<label class="' + (checked ? 'checked' : '') + '">'
                        + '<input type="checkbox" ' + (checked ? 'checked' : '') + ' data-key="' + c.key + '" data-type="' + type + '" onchange="toggleSearchCol(this)">'
                        + c.label + '</label>';
                }).join('');
            }
        }

        function toggleSearchCol(checkbox) {
            var type   = checkbox.getAttribute('data-type');
            var hidden = type === 'hitter' ? hiddenHitterCols : hiddenPitcherCols;
            var key    = checkbox.getAttribute('data-key');
            if (checkbox.checked) { hidden.delete(key); checkbox.parentElement.classList.add('checked'); }
            else                  { hidden.add(key);    checkbox.parentElement.classList.remove('checked'); }
            renderPlayerSearch();
        }

        function selectAllSearchCols(type) {
            var hidden = type === 'hitter' ? hiddenHitterCols : hiddenPitcherCols;
            hidden.clear();
            buildSearchColCheckboxes(type);
            renderPlayerSearch();
        }

        function selectNoneSearchCols(type) {
            var cols   = type === 'hitter' ? ALL_HITTER_COLS  : ALL_PITCHER_COLS;
            var hidden = type === 'hitter' ? hiddenHitterCols : hiddenPitcherCols;
            var always = ['watch','dnw','name','P','status'];
            cols.forEach(function(c) { if (always.indexOf(c.key) === -1) hidden.add(c.key); });
            buildSearchColCheckboxes(type);
            renderPlayerSearch();
        }

        var ALL_HITTER_COLS = [
            { key: 'watch',    label: 'Watch' },
            { key: 'dnw',     label: 'üö´' },
            { key: 'name',     label: 'Player' },
            { key: 'P',        label: 'Pos' },
            { key: 'status',   label: 'Status' },
            { key: '_rank0', label: 'Rank 1', rankCol: 0 },
            { key: '_rank1', label: 'Rank 2', rankCol: 1 },
            { key: '_rank2', label: 'Rank 3', rankCol: 2 },
            { key: 'Age',      label: 'Age' },
            { key: 'T',        label: 'Throw' },
            { key: 'B',        label: 'Bat' },
            { key: 'AVG',      label: 'AVG',    dec: 3 },
            { key: 'OBP',      label: 'OBP',    dec: 3 },
            { key: 'SPC',      label: 'SLG',    dec: 3 },
            { key: 'OPS',      label: 'OPS',    dec: 3 },
            { key: 'OPS+',     label: 'OPS+',   dec: 0 },
            { key: 'wRC+',     label: 'wRC+',   dec: 0 },
            { key: 'wOBA',     label: 'wOBA',   dec: 3 },
            { key: 'ISO',      label: 'ISO',    dec: 3 },
            { key: 'BABIP',    label: 'BABIP',  dec: 3 },
            { key: 'HR',       label: 'HR',     dec: 0 },
            { key: 'RBI',      label: 'RBI',    dec: 0 },
            { key: 'SB',       label: 'SB',     dec: 0 },
            { key: 'R',        label: 'R',      dec: 0 },
            { key: 'BB',       label: 'BB',     dec: 0 },
            { key: 'K',        label: 'K',      dec: 0 },
            { key: 'PA',       label: 'PA',     dec: 0 },
            { key: 'AB',       label: 'AB',     dec: 0 },
            { key: 'TB',       label: 'TB',     dec: 0 },
            { key: 'EBH',      label: 'XBH',    dec: 0 },
            { key: 'RC',       label: 'RC',     dec: 0 },
            { key: 'RC27',     label: 'RC/27',  dec: 2 },
            { key: 'L-PA',     label: 'vs L PA',  dec: 0 },
            { key: 'L-AVG',    label: 'vs L AVG', dec: 3 },
            { key: 'L-OBP',    label: 'vs L OBP', dec: 3 },
            { key: 'L-SPC',    label: 'vs L SPC', dec: 3 },
            { key: 'L-OPS',    label: 'vs L OPS', dec: 3 },
            { key: 'R-PA',     label: 'vs R PA',  dec: 0 },
            { key: 'R-AVG',    label: 'vs R AVG', dec: 3 },
            { key: 'R-OBP',    label: 'vs R OBP', dec: 3 },
            { key: 'R-SPC',    label: 'vs R SPC', dec: 3 },
            { key: 'R-OPS',    label: 'vs R OPS', dec: 3 },
            { key: 'Injury',   label: 'Injury',   dec: 0 },
            { key: 'WAR-BR',   label: 'WAR(BR)', dec: 1 },
            { key: 'WAR-FG',   label: 'WAR(FG)', dec: 1 },
            { key: 'c',      label: 'C Fld',   frating: true },
            { key: '1b',     label: '1B Fld',  frating: true },
            { key: '2b',     label: '2B Fld',  frating: true },
            { key: '3b',     label: '3B Fld',  frating: true },
            { key: 'ss',     label: 'SS Fld',  frating: true },
            { key: 'lf',     label: 'LF Fld',  frating: true },
            { key: 'cf',     label: 'CF Fld',  frating: true },
            { key: 'rf',     label: 'RF Fld',  frating: true },
            { key: 'OF-Arm', label: 'OF Arm',  frating: true },
            { key: 'C-Arm',  label: 'C Arm',   frating: true },
            { key: 'Run',    label: 'Run',      frating: true },
            { key: 'Stl',    label: 'Stl',      frating: true },
];

        var ALL_PITCHER_COLS = [
            { key: 'watch',   label: 'Watch' },
            { key: 'dnw',     label: 'üö´' },
            { key: 'name',    label: 'Player' },
            { key: 'P',       label: 'Pos' },
            { key: 'status',  label: 'Status' },
            { key: '_rank0', label: 'Rank 1', rankCol: 3 },
            { key: '_rank1', label: 'Rank 2', rankCol: 4 },
            { key: '_rank2', label: 'Rank 3', rankCol: 5 },
            { key: 'Age',     label: 'Age' },
            { key: 'T',       label: 'Throw' },
            { key: 'B',       label: 'Bat' },
            { key: 'ERA',     label: 'ERA',    dec: 2 },
            { key: 'FIP',     label: 'FIP',    dec: 2 },
            { key: 'xFIP',    label: 'xFIP',   dec: 2 },
            { key: 'CERA',    label: 'CERA',   dec: 2 },
            { key: 'ERA+',    label: 'ERA+',   dec: 0 },
            { key: 'WHIP',    label: 'WHIP',   dec: 3 },
            { key: 'W',       label: 'W',      dec: 0 },
            { key: 'L',       label: 'L',      dec: 0 },
            { key: 'S',       label: 'SV',     dec: 0 },
            { key: 'K',       label: 'K',      dec: 0 },
            { key: 'IP',      label: 'IP',     dec: 1 },
            { key: 'G',       label: 'G',      dec: 0 },
            { key: 'GS',      label: 'GS',     dec: 0 },
            { key: 'K/9',     label: 'K/9',    dec: 1 },
            { key: 'BB/9',    label: 'BB/9',   dec: 2 },
            { key: 'H/9',     label: 'H/9',    dec: 1 },
            { key: 'HR/9',    label: 'HR/9',   dec: 2 },
            { key: 'K/BB',    label: 'K/BB',   dec: 2 },
            { key: 'BABIP',   label: 'BABIP',  dec: 3 },
            { key: 'L-PA',    label: 'vs L PA',  dec: 0 },
            { key: 'L-AVG',   label: 'vs L AVG', dec: 3 },
            { key: 'L-OBP',   label: 'vs L OBP', dec: 3 },
            { key: 'L-SPC',   label: 'vs L SPC', dec: 3 },
            { key: 'L-OPS',   label: 'vs L OPS', dec: 3 },
            { key: 'R-PA',    label: 'vs R PA',  dec: 0 },
            { key: 'R-AVG',   label: 'vs R AVG', dec: 3 },
            { key: 'R-OBP',   label: 'vs R OBP', dec: 3 },
            { key: 'R-SPC',   label: 'vs R SPC', dec: 3 },
            { key: 'R-OPS',   label: 'vs R OPS', dec: 3 },
            { key: 'SDur',    label: 'SDur',   dec: 0 },
            { key: 'RDur',    label: 'RDur',   dec: 0 },
            { key: 'Injury',  label: 'Injury',   dec: 0 },
            { key: 'WAR-BR',  label: 'WAR(BR)', dec: 1 },
            { key: 'WAR-FG',  label: 'WAR(FG)', dec: 1 }
        ];



        // Roster uses full column sets
        var HITTER_COLS = ALL_HITTER_COLS;
        var PITCHER_COLS = ALL_PITCHER_COLS;

        var searchDragSrcKey = null, searchDragSrcType = null;
        function searchDragStart(e) {
            searchDragSrcKey  = e.currentTarget.getAttribute('data-key');
            searchDragSrcType = e.currentTarget.getAttribute('data-type');
            e.dataTransfer.effectAllowed = 'move';
        }
        function searchDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }
        function searchDrop(e) {
            e.preventDefault();
            var tKey  = e.currentTarget.getAttribute('data-key');
            var tType = e.currentTarget.getAttribute('data-type');
            e.currentTarget.classList.remove('drag-over');
            if (!searchDragSrcKey || searchDragSrcKey === tKey || searchDragSrcType !== tType) return;
            var allCols = tType === 'hitter' ? ALL_HITTER_COLS : ALL_PITCHER_COLS;
            var always  = ['watch','dnw','name','P','status'];
            var order   = tType === 'hitter' ? searchColOrderHitter : searchColOrderPitcher;
            if (!order) order = allCols.filter(function(c){return always.indexOf(c.key)===-1;}).map(function(c){return c.key;});
            var si = order.indexOf(searchDragSrcKey);
            if (si !== -1) order.splice(si, 1);
            var ti = order.indexOf(tKey);
            if (ti === -1) order.push(searchDragSrcKey); else order.splice(ti, 0, searchDragSrcKey);
            if (tType === 'hitter') searchColOrderHitter = order; else searchColOrderPitcher = order;
            buildSearchColCheckboxes(tType);
            renderPlayerSearch();
        }
        function toggleSearchColVisibility(key, type) {
            var hidden = type === 'hitter' ? hiddenHitterCols : hiddenPitcherCols;
            if (hidden.has(key)) hidden.delete(key); else hidden.add(key);
            buildSearchColCheckboxes(type);
            renderPlayerSearch();
        }

        function renderSearchTable(theadId, tbodyId, rows, allCols, hiddenSet, emptyMsg) {
            var thead = document.getElementById(theadId);
            var tbody = document.getElementById(tbodyId);
            if (!thead || !tbody) return;

            var type = allCols === ALL_HITTER_COLS ? 'hitter' : 'pitcher';
            var visCols = getSearchOrderedCols(type, hiddenSet);
            visCols.forEach(function(c) {
                if (c.rankCol !== undefined) c.label = rNames[c.rankCol] || ('Rank ' + (c.rankCol+1));
            });

            thead.innerHTML = '<tr>' + visCols.map(function(c) {
                var li = c.rankCol;
                var hasData = li !== undefined && Object.keys(rLists[li].data).length > 0;
                var sortable = hasData || c.dec !== undefined || c.key === 'Age';
                var cls = sortable ? 'sortable' : '';
                var isActive = searchSortCol === c.key && searchSortList === (li !== undefined ? li : -1);
                if (isActive) cls += (searchSortDir === 'asc' ? ' sort-asc' : ' sort-desc');
                var onclick = sortable
                    ? ' onclick="setSearchSort(\'' + c.key + '\',' + (li !== undefined ? li : 'undefined') + ')"'
                    : '';
                return '<th class="' + cls + '"' + onclick + '>' + c.label + '</th>';
            }).join('') + '</tr>';

            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="' + visCols.length + '" style="text-align:center;padding:30px;color:#6c757d;">' + emptyMsg + '</td></tr>';
                return;
            }

            tbody.innerHTML = rows.slice(0, 300).map(function(p) {
                var av     = getAvailability(p);
                var isDnw  = isDNW(p);
                var rowCls = isDnw ? 'dnw-row' : av !== 'available' ? 'unavailable' : isWatched(p) ? 'watched' : '';
                var avLabel = isDnw
                    ? dnwBadge()
                    : av === 'available'
                    ? '<span style="color:#28a745;font-weight:700;">Available</span>'
                    : av === 'keeper'
                    ? '<span style="color:#0c5460;">Keeper</span>'
                    : '<span style="color:#6c757d;">Drafted</span>';
                var cells = visCols.map(function(c) {
                    if (c.key === 'watch')  return '<td>' + watchBtn(p) + '</td>';
                    if (c.key === 'dnw')    return '<td>' + dnwBtn(p) + '</td>';
                    if (c.key === 'name')   return '<td style="font-weight:600;white-space:nowrap">' + p.First + ' ' + p.Last + '</td>';
                    if (c.key === 'P')      return '<td><span class="pos-badge">' + getPosDisplay(p) + '</span></td>';
                    if (c.key === 'status') return '<td>' + avLabel + '</td>';
                    if (c.key === 'Age')    return '<td>' + (p.Age || '‚Äî') + '</td>';
                    if (c.key === 'T')      return '<td>' + (p.T || '‚Äî') + '</td>';
                    if (c.key === 'B')      return '<td>' + (p.B || '‚Äî') + '</td>';
                    if (c.key === 'Injury') return '<td>' + (p.Injury || '‚Äî') + '</td>';
                    if (c.key === 'SDur')   return '<td>' + (p.SDur || '‚Äî') + '</td>';
                    if (c.key === 'RDur')   return '<td>' + (p.RDur || '‚Äî') + '</td>';
                    if (c.rankCol !== undefined) return rankBadge(getPlayerRank(p, c.rankCol), c.rankCol);
                    if (c.frating) {
                        var rv = p[c.key];
                        if (!rv) return '<td style="color:#ccc">‚Äî</td>';
                        return '<td style="background:' + gradeBg(rv) + ';color:' + gradeColor(rv) + ';font-weight:600;white-space:nowrap;font-size:0.85em">' + fmtGrade(rv) + '</td>';
                    }
                    var val = fmt(p[c.key], c.dec);
                    return '<td style="color:' + (val === '‚Äî' ? '#ccc' : '#333') + '">' + val + '</td>';
                }).join('');
                return '<tr class="' + rowCls + '">' + cells + '</tr>';
            }).join('');
        }


        function getFilteredPlayers() {
            var search      = (document.getElementById('search').value || '').toLowerCase();
            var availFilter = (document.getElementById('avail-filter') || {value:'available'}).value || 'available';
            return players.filter(function(p) {
                if (!searchPlayerMatchesFilter(p)) return false;
                if (search && (p.First + ' ' + p.Last).toLowerCase().indexOf(search) === -1) return false;
                if (availFilter === 'available' && getAvailability(p) !== 'available') return false;
                if (availFilter === 'available' && isDNW(p)) return false;
                if (availFilter === 'dnw' && !isDNW(p)) return false;
                return true;
            });
        }

        function renderPlayerSearch() {
            var filtered = getFilteredPlayers();

            if (searchSortCol && searchSortCol.startsWith('_rank')) {
                var li = searchSortList;
                filtered = filtered.slice().sort(function(a, b) {
                    var ar = getPlayerRank(a, li), br = getPlayerRank(b, li);
                    if (ar === null && br === null) return 0;
                    if (ar === null) return 1;
                    if (br === null) return -1;
                    var ord = rLists[li].order;
                    var cmp = ord === 'asc' ? ar - br : br - ar;
                    return searchSortDir === 'asc' ? cmp : -cmp;
                });
            } else if (searchSortCol) {
                filtered = filtered.slice().sort(function(a, b) {
                    var av = parseFloat(a[searchSortCol]), bv = parseFloat(b[searchSortCol]);
                    var an = isNaN(av) ? (searchSortDir==='asc'?Infinity:-Infinity) : av;
                    var bn = isNaN(bv) ? (searchSortDir==='asc'?Infinity:-Infinity) : bv;
                    return searchSortDir === 'asc' ? an - bn : bn - an;
                });
            }

            var hitters  = filtered.filter(function(p) { return !isPitcher(p); });
            var pitchers = filtered.filter(function(p) { return  isPitcher(p); });

            var hCount = document.getElementById('search-hitter-count');
            var pCount = document.getElementById('search-pitcher-count');
            var label  = document.getElementById('player-count-label');
            if (hCount) hCount.textContent = '(' + hitters.length + ')';
            if (pCount) pCount.textContent = '(' + pitchers.length + ')';
            if (label)  label.textContent  = filtered.length + ' players';

            renderSearchTable('search-hitter-thead', 'search-hitter-tbody', hitters,  ALL_HITTER_COLS,  hiddenHitterCols,  'No hitters match');
            renderSearchTable('search-pitcher-thead','search-pitcher-tbody', pitchers, ALL_PITCHER_COLS, hiddenPitcherCols, 'No pitchers match');
        }



        // √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Roster column picker √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
        var hiddenRosterHitterCols  = new Set();
        var hiddenRosterPitcherCols = new Set();
        var rosterColOrderHitter  = null;
        var rosterColOrderPitcher = null;
        var rosterReorderMode     = { hitter: false, pitcher: false };
        var rosterActivePosFiltersHitter = new Set();
        var rosterActivePosFiltersPitcher = new Set();

        function rosterColPrefsKey(type) { return 'colPrefs_roster_' + type + '_' + getMyTeam(); }

        function loadRosterColPrefs() {
            try {
                var h = localStorage.getItem(rosterColPrefsKey('hitter'));
                var p = localStorage.getItem(rosterColPrefsKey('pitcher'));
                hiddenRosterHitterCols  = h ? new Set(JSON.parse(h)) : new Set();
                hiddenRosterPitcherCols = p ? new Set(JSON.parse(p)) : new Set();
                var hOrder = localStorage.getItem(rosterColPrefsKey('hitter') + '_order');
                var pOrder = localStorage.getItem(rosterColPrefsKey('pitcher') + '_order');
                rosterColOrderHitter  = hOrder ? JSON.parse(hOrder) : null;
                rosterColOrderPitcher = pOrder ? JSON.parse(pOrder) : null;
            } catch(e) {}
        }

        function saveRosterColPrefs() {
            localStorage.setItem(rosterColPrefsKey('hitter'),  JSON.stringify(Array.from(hiddenRosterHitterCols)));
            localStorage.setItem(rosterColPrefsKey('pitcher'), JSON.stringify(Array.from(hiddenRosterPitcherCols)));
            if (rosterColOrderHitter) localStorage.setItem(rosterColPrefsKey('hitter') + '_order', JSON.stringify(rosterColOrderHitter));
            if (rosterColOrderPitcher) localStorage.setItem(rosterColPrefsKey('pitcher') + '_order', JSON.stringify(rosterColOrderPitcher));
            var toast = document.getElementById('save-toast');
            if (toast) { toast.classList.add('show'); setTimeout(function() { toast.classList.remove('show'); }, 2000); }
        }

        function toggleRosterColPicker(type) {
            var panel = document.getElementById('col-picker-roster-' + type);
            var open  = panel.style.display === 'none';
            panel.style.display = open ? '' : 'none';
            if (open) buildRosterColCheckboxes(type);
        }

        function toggleRosterReorder(type) {
            rosterReorderMode[type] = !rosterReorderMode[type];
            var btn = document.getElementById('roster-reorder-btn-' + type);
            if (rosterReorderMode[type]) {
                btn.textContent = '‚úì Done';
                btn.style.background = '#28a745';
                btn.style.borderColor = '#28a745';
                btn.style.color = 'white';
            } else {
                btn.textContent = '‚áÖ Reorder';
                btn.style.background = '#e8eef8';
                btn.style.borderColor = '#1e3c72';
                btn.style.color = '#1e3c72';
            }
            buildRosterColCheckboxes(type);
        }

        function getRosterOrderedCols(type, hiddenSet) {
            var allCols = type === 'hitter' ? HITTER_COLS : PITCHER_COLS;
            var order   = type === 'hitter' ? rosterColOrderHitter : rosterColOrderPitcher;
            var always = ['name', 'P'];
            var orderable = allCols.filter(function(c) { return always.indexOf(c.key) === -1; });
            
            if (!order) {
                return orderable.filter(function(c) { return !hiddenSet.has(c.key); });
            }
            
            var ordered = [];
            order.forEach(function(key) {
                var col = orderable.find(function(c) { return c.key === key; });
                if (col && !hiddenSet.has(key)) ordered.push(col);
            });
            
            orderable.forEach(function(c) {
                if (order.indexOf(c.key) === -1 && !hiddenSet.has(c.key)) ordered.push(c);
            });
            
            return ordered;
        }

        var rosterDragSrcKey = null, rosterDragSrcType = null;
        function rosterDragStart(e) {
            rosterDragSrcKey  = e.currentTarget.getAttribute('data-key');
            rosterDragSrcType = e.currentTarget.getAttribute('data-type');
        }

        function rosterDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function rosterDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function rosterDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            var targetKey  = e.currentTarget.getAttribute('data-key');
            var targetType = e.currentTarget.getAttribute('data-type');
            
            if (rosterDragSrcKey === targetKey || rosterDragSrcType !== targetType) return;
            
            var allCols = targetType === 'hitter' ? HITTER_COLS : PITCHER_COLS;
            var always = ['name', 'P'];
            var orderable = allCols.filter(function(c) { return always.indexOf(c.key) === -1; });
            var order = targetType === 'hitter' ? rosterColOrderHitter : rosterColOrderPitcher;
            
            if (!order) {
                order = orderable.map(function(c) { return c.key; });
            }
            
            var srcIdx = order.indexOf(rosterDragSrcKey);
            var tgtIdx = order.indexOf(targetKey);
            
            if (srcIdx !== -1) order.splice(srcIdx, 1);
            else order = order.filter(function(k) { return k !== rosterDragSrcKey; }).concat([rosterDragSrcKey]);
            
            tgtIdx = order.indexOf(targetKey);
            order.splice(tgtIdx, 0, rosterDragSrcKey);
            
            if (targetType === 'hitter') rosterColOrderHitter = order;
            else rosterColOrderPitcher = order;
            
            buildRosterColCheckboxes(targetType);
        }

        function toggleRosterColVisibility(key, type) {
            var hidden = type === 'hitter' ? hiddenRosterHitterCols : hiddenRosterPitcherCols;
            if (hidden.has(key)) hidden.delete(key);
            else hidden.add(key);
            buildRosterColCheckboxes(type);
            renderRosterTable();
        }

        function buildRosterColCheckboxes(type) {
            var cols   = type === 'hitter' ? HITTER_COLS : PITCHER_COLS;
            var hidden = type === 'hitter' ? hiddenRosterHitterCols : hiddenRosterPitcherCols;
            var always = ['name', 'P'];
            var inReorderMode = rosterReorderMode[type];
            
            if (inReorderMode) {
                var order = type === 'hitter' ? rosterColOrderHitter : rosterColOrderPitcher;
                var orderable = cols.filter(function(c) { return always.indexOf(c.key) === -1; });
                
                if (!order) {
                    order = orderable.map(function(c) { return c.key; });
                    if (type === 'hitter') rosterColOrderHitter = order;
                    else rosterColOrderPitcher = order;
                }
                
                var chips = order.map(function(key) {
                    var col = orderable.find(function(c) { return c.key === key; });
                    if (!col) return '';
                    var isHidden = hidden.has(key);
                    var eyeIcon = isHidden ? 'üëÅÔ∏è' : 'üëÅ';
                    return '<div class="col-chip" draggable="true" data-key="' + key + '" data-type="' + type + '" '
                        + 'ondragstart="rosterDragStart(event)" ondragover="rosterDragOver(event)" '
                        + 'ondragleave="rosterDragLeave(event)" ondrop="rosterDrop(event)">'
                        + '<span class="drag-handle">‚ò∞</span>'
                        + '<span class="chip-label">' + col.label + '</span>'
                        + '<span class="eye-toggle" onclick="toggleRosterColVisibility(\'' + key + '\', \'' + type + '\')">' + eyeIcon + '</span>'
                        + '</div>';
                }).join('');
                
                document.getElementById('col-checkboxes-roster-' + type).innerHTML = chips;
            } else {
                document.getElementById('col-checkboxes-roster-' + type).innerHTML = cols
                    .filter(function(c) { return always.indexOf(c.key) === -1; })
                    .map(function(c) {
                        var checked = !hidden.has(c.key);
                        return '<label class="' + (checked ? 'checked' : '') + '">' + '<input type="checkbox" ' + (checked ? 'checked' : '') + ' data-key="' + c.key + '" data-type="' + type + '" onchange="toggleRosterCol(this)">' + c.label + '</label>';
                    }).join('');
            }
        }

        function toggleRosterCol(checkbox) {
            var type   = checkbox.getAttribute('data-type');
            var hidden = type === 'hitter' ? hiddenRosterHitterCols : hiddenRosterPitcherCols;
            var key    = checkbox.getAttribute('data-key');
            if (checkbox.checked) { hidden.delete(key); checkbox.parentElement.classList.add('checked'); }
            else                  { hidden.add(key);    checkbox.parentElement.classList.remove('checked'); }
            renderRosterTable();
        }

        function selectAllRosterCols(type) {
            (type === 'hitter' ? hiddenRosterHitterCols : hiddenRosterPitcherCols).clear();
            buildRosterColCheckboxes(type); renderRosterTable();
        }

        function selectNoneRosterCols(type) {
            var cols   = type === 'hitter' ? HITTER_COLS : PITCHER_COLS;
            var hidden = type === 'hitter' ? hiddenRosterHitterCols : hiddenRosterPitcherCols;
            var always = ['name', 'P'];
            cols.forEach(function(c) { if (always.indexOf(c.key) === -1) hidden.add(c.key); });
            buildRosterColCheckboxes(type); renderRosterTable();
        }

        function renderAll() {
            renderHeader();
            renderRoster();
            renderMyPicks();
            renderWatchlist();
            renderPlayerSearch();
        }





        // √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê
        // RANKINGS  (3 lists, per-team localStorage)
        // √¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê√¢‚Ä¢¬ê
        var rLists = [
            {data:{},order:'asc'}, {data:{},order:'asc'}, {data:{},order:'asc'},  // Hitter ranks 0-2
            {data:{},order:'asc'}, {data:{},order:'asc'}, {data:{},order:'asc'}   // Pitcher ranks 3-5
        ];
        var rNames = [
            'Hitter Rank 1', 'Hitter Rank 2', 'Hitter Rank 3',
            'Pitcher Rank 1', 'Pitcher Rank 2', 'Pitcher Rank 3'
        ];
        var activeRankTab  = 0;
        var pendingRows    = [null, null, null, null, null, null];
        var searchSortCol  = null;
        var searchSortDir  = 'asc';
        var searchSortList = 0;   // which list (0/1/2) drives sort

        function rKey(i)     { return 'busterRankings_' + i + '_' + (getMyTeam()||'x'); }
        function rNameKey(i) { return 'busterRankingsName_' + i + '_' + (getMyTeam()||'x'); }


        function refreshRankingsTabs() {
            for (var i = 0; i < 3; i++) {
                var count = Object.keys(rLists[i].data).length;
                var loadedEl = document.getElementById('rlist-loaded-' + i);
                var countEl  = document.getElementById('rlist-count-' + i);
                var tabBtn   = document.querySelectorAll('.rtab')[i];
                var nameEl   = document.getElementById('rname-' + i);
                if (nameEl) nameEl.value = rNames[i];
                if (count > 0) {
                    if (loadedEl) loadedEl.style.display = 'flex';
                    if (countEl)  countEl.textContent = count + ' ranked';
                    if (tabBtn)   tabBtn.textContent = (count > 0 ? '‚úî ' : '') + rNames[i];
                } else {
                    if (loadedEl) loadedEl.style.display = 'none';
                    if (tabBtn)   tabBtn.textContent = rNames[i];
                }
            }
        }

        function saveRankingsName(i) {
            var el = document.getElementById('rname-' + i);
            if (!el) return;
            rNames[i] = el.value;
            localStorage.setItem(rNameKey(i), rNames[i]);
            refreshRankingsTabs();
        }


        function switchRankingsTab(idx) {
            activeRankTab = idx;
            var tabs = document.querySelectorAll('.rtab');
            tabs.forEach(function(t, i) {
                t.className = i === idx ? 'rtab rtab-active' : 'rtab';
            });
            for (var j = 0; j < 6; j++) {
                var pane = document.getElementById('rankings-tab-' + j);
                if (pane) pane.style.display = j === idx ? 'block' : 'none';
            }
        }






        function buildColMap(listIdx, cols) {
            var defs = [
                {id:'rmap-first-'+listIdx, hints:['first','firstname','fname','given']},
                {id:'rmap-last-'+listIdx,  hints:['last','lastname','lname','surname','family']},
                {id:'rmap-rank-'+listIdx,  hints:['rank','ranking','score','value','rating','#','no','num','priority']}
            ];
            defs.forEach(function(def) {
                var sel = document.getElementById(def.id);
                if (!sel) return;
                sel.innerHTML = '<option value="">‚Äî select ‚Äî</option>' +
                    cols.map(function(c){return '<option value="'+c.replace(/"/g,'&quot;')+'">'+c+'</option>';}).join('');
                var lower = cols.map(function(c){return c.toLowerCase();});
                def.hints.forEach(function(h){
                    if (sel.value) return;
                    for(var k=0;k<lower.length;k++){
                        if(lower[k]===h||lower[k].indexOf(h)!==-1){sel.value=cols[k];break;}
                    }
                });
            });
        }

        function applyRankingsList(listIdx) {
            var rows  = pendingRows[listIdx];
            if (!rows) return;
            var fCol  = document.getElementById('rmap-first-'+listIdx).value;
            var lCol  = document.getElementById('rmap-last-'+listIdx).value;
            var rCol  = document.getElementById('rmap-rank-'+listIdx).value;
            var order = document.getElementById('rmap-order-'+listIdx).value;
            if (!fCol||!lCol||!rCol) { setRStatus(listIdx,'Select all three columns.','error'); return; }
            var data={}, imported=0, skipped=0;
            rows.forEach(function(row){
                var fn=String(row[fCol]||'').trim(), ln=String(row[lCol]||'').trim();
                var rv=parseFloat(String(row[rCol]||'').replace(/,/g,''));
                if(!fn||!ln||isNaN(rv)){skipped++;return;}
                data[fn.toLowerCase()+'|'+ln.toLowerCase()]=rv;
                imported++;
            });
            rLists[listIdx].data  = data;
            rLists[listIdx].order = order;
            localStorage.setItem(rKey(listIdx), JSON.stringify(data));
            localStorage.setItem(rKey(listIdx)+'_order', order);
            setRStatus(listIdx, '‚úî '+imported+' players imported'+(skipped?' ('+skipped+' skipped).':'.'), 'ok');
            pendingRows[listIdx] = null;
            resetRankingsFile(listIdx);
            refreshRankingsTabs();
            renderPlayerSearch();
        }

        function resetRankingsFile(listIdx) {
            var dz  = document.getElementById('rlist-dz-'  + listIdx);
            var map = document.getElementById('rlist-map-' + listIdx);
            var fi  = document.getElementById('rlist-file-'+ listIdx);
            if (dz)  dz.style.display  = 'block';
            if (map) map.style.display = 'none';
            if (fi)  fi.value = '';
        }

        function clearRankingsList(listIdx) {
            rLists[listIdx].data = {};
            localStorage.removeItem(rKey(listIdx));
            setRStatus(listIdx,'','');
            refreshRankingsTabs();
            if (searchSortCol === '_rank'+listIdx) { searchSortCol = null; }
            renderPlayerSearch();
        }

        function setRStatus(listIdx, msg, type) {
            var el = document.getElementById('rlist-status-'+listIdx);
            if (!el) return;
            el.textContent = msg;
            el.className = 'rankings-status'+(type?' '+type:'');
        }

        function getPlayerRank(p, listIdx) {
            var key=(p.First||'').toLowerCase()+'|'+(p.Last||'').toLowerCase();
            var v = rLists[listIdx].data[key];
            return v !== undefined ? v : null;
        }

        function rankBadge(rank, listIdx) {
            if (rank === null) return '<td style="color:#ccc;text-align:center;">‚Äî</td>';
            var n = parseFloat(rank);
            var ord = rLists[listIdx] ? rLists[listIdx].order : 'asc';
            var isGood = ord === 'asc' ? (!isNaN(n) && n <= 10) : (!isNaN(n) && n >= 90);
            var isMid  = ord === 'asc' ? (!isNaN(n) && n <= 25) : (!isNaN(n) && n >= 75);
            var cls = isGood ? 'rank-top10' : isMid ? 'rank-top25' : 'rank-normal';
            return '<td style="text-align:center;"><span class="rank-badge '+cls+'">'+(Number.isInteger(n)?n:rank)+'</span></td>';
        }

        function setSearchSort(col, listIdx) {
            if (searchSortCol === col && searchSortList === listIdx) {
                searchSortDir = searchSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                searchSortCol  = col;
                searchSortList = listIdx !== undefined ? listIdx : 0;
                searchSortDir  = col.startsWith('_rank') ? 'asc' : 'desc';
            }
            renderPlayerSearch();
        }


        function toggleRankingsPanel() {
            var panel = document.getElementById('rankings-panel');
            if (!panel) return;
            panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
            if (panel.style.display === 'block') {
                refreshRankingsTabs();
                switchRankingsTab(activeRankTab);
            }
        }

        function handleRankingsFile(file, listIdx) {
            if (!file) return;
            setRStatus(listIdx, 'Reading file\u2026', 'info');
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var rows = file.name.toLowerCase().endsWith('.csv')
                        ? parseCSVRankings(e.target.result)
                        : parseXLSXRankings(e.target.result);
                    if (!rows || !rows.length) { setRStatus(listIdx, 'No rows found.', 'error'); return; }
                    pendingRows[listIdx] = rows;
                    buildColMap(listIdx, Object.keys(rows[0]));
                    document.getElementById('rlist-dz-'  + listIdx).style.display = 'none';
                    document.getElementById('rlist-map-' + listIdx).style.display = 'block';
                    setRStatus(listIdx, 'File read \u2014 map columns then click Import.', 'info');
                } catch(err) { setRStatus(listIdx, 'Error: ' + err.message, 'error'); }
            };
            if (file.name.toLowerCase().endsWith('.csv')) reader.readAsText(file);
            else reader.readAsArrayBuffer(file);
        }

        function parseXLSXRankings(buf) {
            if (typeof XLSX === 'undefined') throw new Error('Use a .csv file (SheetJS unavailable).');
            var wb = XLSX.read(new Uint8Array(buf), {type:'array'});
            return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:''});
        }

        function parseCSVRankings(text) {
            var lines = text.split(/\r?\n/).filter(function(l){return l.trim();});
            if (!lines.length) return [];
            var headers = splitCSVLine(lines[0]);
            return lines.slice(1).map(function(line) {
                var vals = splitCSVLine(line), obj = {};
                headers.forEach(function(h,i){obj[h.trim()]=(vals[i]||'').trim();});
                return obj;
            });
        }

        function splitCSVLine(line) {
            var out=[],cur='',inQ=false;
            for(var i=0;i<line.length;i++){
                var c=line[i];
                if(c==='"'){inQ=!inQ;}
                else if(c===','&&!inQ){out.push(cur);cur='';}
                else{cur+=c;}
            }
            out.push(cur); return out;
        }

        function loadRankings() {
            for (var i = 0; i < 6; i++) {
                var saved = localStorage.getItem(rKey(i));
                if (saved) {
                    try {
                        var parsed = JSON.parse(saved);
                        rLists[i].data = parsed.data || {};
                        rLists[i].order = parsed.order || 'asc';
                    } catch(e) { rLists[i].data = {}; }
                }
                var savedName = localStorage.getItem(rNameKey(i));
                if (savedName) rNames[i] = savedName;
                
                var loadedEl = document.getElementById('rlist-loaded-' + i);
                var countEl  = document.getElementById('rlist-count-' + i);
                var nameEl   = document.getElementById('rname-' + i);
                if (nameEl) nameEl.value = rNames[i];
                
                var count = Object.keys(rLists[i].data).length;
                if (count && loadedEl && countEl) {
                    countEl.textContent = count + ' players loaded';
                    loadedEl.style.display = 'flex';
                }
            }
            renderPlayerSearch();
            renderWatchlist();
        }


        // √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Watchlist column picker √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
        function wlColPrefsKey(type) { return 'wlColPrefs_' + type + '_' + (getMyTeam() || 'x'); }
        function wlColOrderKey(type)  { return 'wlColOrder_' + type + '_' + (getMyTeam() || 'x'); }

        function loadWLColPrefs() {
            try {
                var h = localStorage.getItem(wlColPrefsKey('hitter'));
                var p = localStorage.getItem(wlColPrefsKey('pitcher'));
                hiddenWLHitterCols  = h ? new Set(JSON.parse(h)) : new Set(['OBP','SPC','wOBA','wRC','BABIP','ISO','pull','cent','oppo','hard','LD','GB','FB','age_adj','c','1b','2b','3b','ss','lf','cf','rf','OF-Arm','C-Arm','Run','Stl','_rank1','_rank2']);
                hiddenWLPitcherCols = p ? new Set(JSON.parse(p)) : new Set(['FIP','xFIP','BABIP_p','LOB','GB_p','HR9','K9','BB9','_rank1','_rank2']);
                var oh = localStorage.getItem(wlColOrderKey('hitter'));
                var op = localStorage.getItem(wlColOrderKey('pitcher'));
                wlColOrderHitter  = oh ? JSON.parse(oh) : null;
                wlColOrderPitcher = op ? JSON.parse(op) : null;
            } catch(e) {
                hiddenWLHitterCols  = new Set();
                hiddenWLPitcherCols = new Set();
            }
        }

        function saveWLColPrefs() {
            localStorage.setItem(wlColPrefsKey('hitter'),  JSON.stringify(Array.from(hiddenWLHitterCols)));
            localStorage.setItem(wlColPrefsKey('pitcher'), JSON.stringify(Array.from(hiddenWLPitcherCols)));
            if (wlColOrderHitter)  localStorage.setItem(wlColOrderKey('hitter'),  JSON.stringify(wlColOrderHitter));
            if (wlColOrderPitcher) localStorage.setItem(wlColOrderKey('pitcher'), JSON.stringify(wlColOrderPitcher));
            var toast = document.getElementById('save-toast');
            if (toast) { toast.classList.add('show'); setTimeout(function() { toast.classList.remove('show'); }, 2000); }
        }

        function toggleWatchlistColPicker(type) {
            var hPanel = document.getElementById('col-picker-wl-hitter');
            var pPanel = document.getElementById('col-picker-wl-pitcher');
            var target = type === 'hitter' ? hPanel : pPanel;
            var other  = type === 'hitter' ? pPanel : hPanel;
            var isOpen = target && target.style.display !== 'none';
            if (other)  other.style.display  = 'none';
            if (target) target.style.display = isOpen ? 'none' : '';
            if (!isOpen) buildWLColCheckboxes(type);
        }

        function toggleWLReorder(type) {
            wlReorderMode[type] = !wlReorderMode[type];
            var btn = document.getElementById('wl-reorder-btn-' + type);
            if (btn) {
                btn.style.background = wlReorderMode[type] ? '#1e3c72' : '#e8eef8';
                btn.style.color      = wlReorderMode[type] ? 'white'   : '#1e3c72';
                btn.textContent      = wlReorderMode[type] ? '\u2713 Done' : '\u2195 Reorder';
            }
            buildWLColCheckboxes(type);
        }

        function buildWLColCheckboxes(type) {
            var allCols = type === 'hitter' ? ALL_HITTER_COLS  : ALL_PITCHER_COLS;
            var hidden  = type === 'hitter' ? hiddenWLHitterCols : hiddenWLPitcherCols;
            var order   = type === 'hitter' ? wlColOrderHitter : wlColOrderPitcher;
            var grid    = document.getElementById('col-checkboxes-wl-' + type);
            if (!grid) return;
            var always  = ['watch','name','P','status'];
            var orderedCols;
            if (order && order.length) {
                var colMap = {};
                allCols.forEach(function(c) { colMap[c.key] = c; });
                orderedCols = order.map(function(k) { return colMap[k]; }).filter(Boolean);
                allCols.forEach(function(c) { if (order.indexOf(c.key) === -1) orderedCols.push(c); });
            } else { orderedCols = allCols.slice(); }
            var showCols = orderedCols.filter(function(c) { return always.indexOf(c.key) === -1; });
            showCols.forEach(function(c) {
                if (c.rankCol !== undefined) c.label = rNames[c.rankCol] || ('Rank ' + (c.rankCol+1));
            });
            if (wlReorderMode[type]) {
                grid.className = 'col-order-grid';
                grid.innerHTML = showCols.map(function(c) {
                    var isHid = hidden.has(c.key);
                    return '<div class="col-order-chip' + (isHid ? ' hidden-col' : '') + '" draggable="true"'
                        + ' data-key="' + c.key + '" data-type="' + type + '"'
                        + ' ondragstart="wlDragStart(event)" ondragover="wlDragOver(event)"'
                        + ' ondrop="wlDrop(event)" ondragleave="this.classList.remove(\'drag-over\')">  '
                        + '<span class="drag-handle">&#9776;</span>'
                        + '<span>' + c.label + '</span>'
                        + '<span class="col-eye" onclick="toggleWLColVisibility(\'' + c.key + '\',\'' + type + '\')">'
                        + (isHid ? '&#128065;&#65039;' : '&#128065;') + '</span>'
                        + '</div>';
                }).join('');
            } else {
                grid.className = 'col-checkbox-grid';
                grid.innerHTML = showCols.map(function(c) {
                    var checked = !hidden.has(c.key);
                    return '<label class="' + (checked ? 'checked' : '') + '">'
                        + '<input type="checkbox" ' + (checked ? 'checked' : '') + ' data-key="' + c.key + '" data-type="' + type + '" onchange="toggleWLCol(this)">'
                        + c.label + '</label>';
                }).join('');
            }
        }

        var wlDragSrcKey = null, wlDragSrcType = null;
        function wlDragStart(e) {
            wlDragSrcKey  = e.currentTarget.getAttribute('data-key');
            wlDragSrcType = e.currentTarget.getAttribute('data-type');
            e.dataTransfer.effectAllowed = 'move';
        }
        function wlDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }
        function wlDrop(e) {
            e.preventDefault();
            var tKey  = e.currentTarget.getAttribute('data-key');
            var tType = e.currentTarget.getAttribute('data-type');
            e.currentTarget.classList.remove('drag-over');
            if (!wlDragSrcKey || wlDragSrcKey === tKey || wlDragSrcType !== tType) return;
            var allCols = tType === 'hitter' ? ALL_HITTER_COLS : ALL_PITCHER_COLS;
            var always  = ['watch','name','P','status'];
            var order   = tType === 'hitter' ? wlColOrderHitter : wlColOrderPitcher;
            if (!order) order = allCols.filter(function(c){return always.indexOf(c.key)===-1;}).map(function(c){return c.key;});
            var si = order.indexOf(wlDragSrcKey);
            if (si !== -1) order.splice(si, 1);
            var ti = order.indexOf(tKey);
            if (ti === -1) order.push(wlDragSrcKey); else order.splice(ti, 0, wlDragSrcKey);
            if (tType === 'hitter') wlColOrderHitter = order; else wlColOrderPitcher = order;
            buildWLColCheckboxes(tType);
            renderWatchlist();
        }
        function toggleWLColVisibility(key, type) {
            var hidden = type === 'hitter' ? hiddenWLHitterCols : hiddenWLPitcherCols;
            if (hidden.has(key)) hidden.delete(key); else hidden.add(key);
            buildWLColCheckboxes(type);
            renderWatchlist();
        }
        function toggleWLCol(cb) {
            var key = cb.getAttribute('data-key'), type = cb.getAttribute('data-type');
            var hidden = type === 'hitter' ? hiddenWLHitterCols : hiddenWLPitcherCols;
            if (cb.checked) hidden.delete(key); else hidden.add(key);
            cb.parentElement.className = cb.checked ? 'checked' : '';
            renderWatchlist();
        }
        function selectAllWLCols(type) {
            var hidden = type === 'hitter' ? hiddenWLHitterCols : hiddenWLPitcherCols;
            hidden.clear(); buildWLColCheckboxes(type); renderWatchlist();
        }
        function selectNoneWLCols(type) {
            var cols = type === 'hitter' ? ALL_HITTER_COLS : ALL_PITCHER_COLS;
            var hidden = type === 'hitter' ? hiddenWLHitterCols : hiddenWLPitcherCols;
            var always = ['watch','name','P','status'];
            cols.forEach(function(c){ if (always.indexOf(c.key) === -1) hidden.add(c.key); });
            buildWLColCheckboxes(type); renderWatchlist();
        }

        var wlActivePosFilters = new Set();  // empty = show all

        function toggleWLPos(pos) {
            if (pos === 'all') {
                wlActivePosFilters.clear();
            } else {
                if (wlActivePosFilters.has(pos)) {
                    wlActivePosFilters.delete(pos);
                } else {
                    wlActivePosFilters.add(pos);
                }
            }
            updateWLPosChips();
            renderWatchlist();
        }

        function updateWLPosChips() {
            var chips = document.querySelectorAll('.pos-chip');
            var allActive = wlActivePosFilters.size === 0;
            chips.forEach(function(chip) {
                var onclick = chip.getAttribute('onclick') || '';
                var posMatch = onclick.match(/toggleWLPos\('([^']+)'\)/);
                if (!posMatch) return;
                var pos = posMatch[1];
                if (pos === 'all') {
                    chip.className = 'pos-chip chip-all' + (allActive ? ' active' : '');
                } else {
                    var isActive = wlActivePosFilters.has(pos);
                    var extraCls = pos === 'SP' ? ' chip-sp' : pos === 'RP' ? ' chip-rp' : '';
                    chip.className = 'pos-chip' + extraCls + (isActive ? ' active' : '');
                }
            });
            var infoEl = document.getElementById('wl-filter-info');
            if (infoEl) {
                if (allActive) {
                    infoEl.textContent = '';
                } else {
                    var list = Array.from(wlActivePosFilters).join(', ');
                    infoEl.textContent = 'Showing: ' + list;
                }
            }
        }

        function wlPlayerMatchesFilter(p) {
            if (wlActivePosFilters.size === 0) return true;
            var pos = (getPlayerPosition(p) || '').toUpperCase();
            var isPitcher = pos === 'SP' || pos === 'RP';
            var isOF = pos === 'LF' || pos === 'CF' || pos === 'RF';
            // Check group filters first
            if (wlActivePosFilters.has('PITCHERS') && isPitcher) return true;
            if (wlActivePosFilters.has('HITTERS')  && !isPitcher) return true;
            if (wlActivePosFilters.has('OF')        && isOF) return true;
            // Check individual position filters
            var eligible = getEligiblePositions(p).map(function(e) { return e.toUpperCase(); });
            if (!eligible.length) eligible = [pos];
            for (var i = 0; i < eligible.length; i++) {
                if (wlActivePosFilters.has(eligible[i])) return true;
            }
            return false;
        }


        // Search position filter (chip-based)
        var searchActivePosFilters = new Set();

        function toggleSearchPos(pos) {
            if (pos === 'all') {
                searchActivePosFilters.clear();
            } else {
                if (searchActivePosFilters.has(pos)) searchActivePosFilters.delete(pos);
                else searchActivePosFilters.add(pos);
            }
            updateSearchPosChips();
            renderPlayerSearch();
        }

        function updateSearchPosChips() {
            var strip = document.getElementById('search-pos-filter');
            if (!strip) return;
            var chips = strip.querySelectorAll('.pos-chip');
            var allActive = searchActivePosFilters.size === 0;
            chips.forEach(function(chip) {
                var onclick = chip.getAttribute('onclick') || '';
                var m = onclick.match(/toggleSearchPos\('([^']+)'\)/);
                if (!m) return;
                var pos = m[1];
                if (pos === 'all') {
                    chip.className = 'pos-chip chip-all' + (allActive ? ' active' : '');
                } else {
                    var extraCls = pos === 'SP' ? ' chip-sp' : pos === 'RP' ? ' chip-rp' : '';
                    chip.className = 'pos-chip' + extraCls + (searchActivePosFilters.has(pos) ? ' active' : '');
                }
            });
            var infoEl = document.getElementById('search-filter-info');
            if (infoEl) infoEl.textContent = allActive ? '' : 'Showing: ' + Array.from(searchActivePosFilters).join(', ');
        }

        function searchPlayerMatchesFilter(p) {
            if (searchActivePosFilters.size === 0) return true;
            var pos = (getPlayerPosition(p) || '').toUpperCase();
            var isPit = pos === 'SP' || pos === 'RP';
            var isOF  = pos === 'LF' || pos === 'CF' || pos === 'RF';
            if (searchActivePosFilters.has('PITCHERS') && isPit)  return true;
            if (searchActivePosFilters.has('HITTERS')  && !isPit) return true;
            if (searchActivePosFilters.has('OF')        && isOF)  return true;
            var eligible = getEligiblePositions(p).map(function(e) { return e.toUpperCase(); });
            if (!eligible.length) eligible = [pos];
            for (var i = 0; i < eligible.length; i++) {
                if (searchActivePosFilters.has(eligible[i])) return true;
            }
            return false;
        }

        // √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ Do Not Want √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
        function getDNWList() {
            try { return JSON.parse(localStorage.getItem('dnw_' + getMyTeam()) || '[]'); }
            catch(e) { return []; }
        }
        function isDNW(p) { return getDNWList().indexOf(watchKey(p)) !== -1; }
        function toggleDNW(key) {
            var dnw = getDNWList();
            var idx = dnw.indexOf(key);
            if (idx !== -1) {
                dnw.splice(idx, 1);
            } else {
                dnw.push(key);
                // mutually exclusive: remove from watchlist if present
                var wl  = getWatchlist();
                var wi  = wl.indexOf(key);
                if (wi !== -1) {
                    wl.splice(wi, 1);
                    localStorage.setItem('watchlist_' + getMyTeam(), JSON.stringify(wl));
                }
            }
            localStorage.setItem('dnw_' + getMyTeam(), JSON.stringify(dnw));
            renderAll();
        }
        function dnwBtn(p) {
            var active = isDNW(p);
            var key    = watchKey(p);
            var cls    = 'dnw-btn' + (active ? ' dnw-active' : '');
            var label  = active ? 'üö´ Skip' : 'üö´';
            return '<button class="' + cls + '" data-dnw-key="' + key + '" title="Mark as Do Not Want">' + label + '</button>';
        }
        function dnwBadge() {
            return '<span class="dnw-badge">‚úï Skip</span>';
        }
        document.addEventListener('DOMContentLoaded', async function() {
            var team = getMyTeam();
            if (!team) { window.location.href = 'login.html'; return; }
            players = await fetch('players.json').then(r => r.json());
            
            loadDraftState();
            loadColPrefs();
            loadRosterColPrefs();
            loadRankings();
            loadWLColPrefs();
            renderAll();

            document.getElementById('search').addEventListener('input', renderPlayerSearch);
            document.getElementById('avail-filter').addEventListener('change', renderPlayerSearch);
            
            // Initialize Firebase sync
            setTimeout(async function() {
                if (window.firebaseInitialized) {
                    try {
                        // Load drafted players from Firebase
                        const draftSnapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'draftedPlayers'));
                        if (draftSnapshot.exists()) {
                            draftedPlayers = unsanitizeFromFirebase(draftSnapshot.val());
                            localStorage.setItem('busterLeagueDraft', JSON.stringify({
                                draftedPlayers: draftedPlayers,
                                currentPickIndex: draftedPlayers.length
                            }));
                            console.log('Loaded', draftedPlayers.length, 'picks from Firebase');
                            renderAll();
                        }
                        
                        // Listen for draft changes
                        window.firebaseOnValue(window.firebaseRef(window.firebaseDB, 'draftedPlayers'), (snapshot) => {
                            const data = unsanitizeFromFirebase(snapshot.val() || []);
                            if (data.length !== draftedPlayers.length) {
                                console.log('Draft updated -', data.length, 'picks');
                                draftedPlayers = data;
                                localStorage.setItem('busterLeagueDraft', JSON.stringify({
                                    draftedPlayers: draftedPlayers,
                                    currentPickIndex: data.length
                                }));
                                renderAll();
                            }
                        });
                        
                        // Load initial watchlist from Firebase
                        const snapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'watchlists/' + team));
                        if (snapshot.exists()) {
                            localStorage.setItem('watchlist_' + team, JSON.stringify(snapshot.val()));
                            console.log('Loaded watchlist from Firebase');
                            renderAll();
                        }
                        
                        // Listen for watchlist changes
                        window.firebaseOnValue(window.firebaseRef(window.firebaseDB, 'watchlists/' + team), (snapshot) => {
                            const data = snapshot.val() || [];
                            const currentWL = getWatchlist();
                            if (JSON.stringify(data) !== JSON.stringify(currentWL)) {
                                console.log('Watchlist updated from another device');
                                localStorage.setItem('watchlist_' + team, JSON.stringify(data));
                                renderAll();
                            }
                        });
                        
                        console.log('Firebase sync enabled for team:', team);
                    } catch (error) {
                        console.error('Firebase sync error:', error);
                    }
                }
            }, 1500);
        });

        window.addEventListener('storage', function(e) {
            if (e.key === 'busterLeagueDraft') { loadDraftState(); renderAll(); }
        });
        window.addEventListener('focus', function() { loadDraftState(); renderAll(); });

</script>
</body>
</html>
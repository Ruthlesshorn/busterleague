<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buster League Draft 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #d94e59 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .draft-status {
            background: white;
            color: #333;
            padding: 20px 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
        }

        .draft-status-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .current-pick {
            font-size: 1.5em;
            font-weight: 700;
            color: #c41e3a;
        }

        .pick-info {
            font-size: 1.1em;
            color: #6c757d;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .draft-order {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            height: 100%;
            overflow-y: auto;
        }

        .draft-order h2 {
            margin-bottom: 15px;
            color: #1e3c72;
            font-size: 1.3em;
            border-bottom: 2px solid #c41e3a;
            padding-bottom: 10px;
        }

        .team-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            background: #f8f9fa;
            border: 2px solid transparent;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .team-item.current-turn {
            background: #c41e3a;
            color: white;
            font-weight: 700;
            border-color: #c41e3a;
            font-size: 1.1em;
        }


        .players-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            font-weight: 600;
            color: #495057;
        }

        select, input[type="text"] {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:hover, input[type="text"]:hover {
            border-color: #c41e3a;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #c41e3a;
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .player-count {
            padding: 12px;
            background: #e9ecef;
            border-radius: 6px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
        }

        .players-table {
            overflow-x: auto;
            max-height: calc(100vh - 400px);
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        thead {
            position: sticky;
            top: 0;
            background: #1e3c72;
            color: white;
            z-index: 10;
        }

        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            background: #2a5298;
        }

        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.5;
        }

        th.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        th.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #dee2e6;
        }

        tbody tr {
            transition: all 0.2s;
            cursor: pointer;
        }

        tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
        }

        tbody tr.drafted {
            opacity: 0.4;
            background: #e9ecef;
            text-decoration: line-through;
        }

        tbody tr.drafted:hover {
            transform: none;
        }

        .draft-button {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .draft-button:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .draft-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .position-badge {
            background: #c41e3a;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.85em;
            display: inline-block;
            text-transform: uppercase;
        }

        .drafted-by {
            font-size: 0.85em;
            color: #6c757d;
            font-weight: 600;
        }

        .draft-history {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .draft-history h2 {
            margin-bottom: 15px;
            color: #1e3c72;
        }

        .draft-picks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }

        .pick-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #c41e3a;
            font-size: 0.9em;
        }

        .pick-number {
            font-weight: 700;
            color: #c41e3a;
        }

        .undo-button {
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .undo-button:hover {
            background: #c82333;
        }

        .undo-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .draft-order {
                max-height: 300px;
            }
        }
    
        /* Dropdown nav */
        .nav-buttons { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .dropdown { position: relative; }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            z-index: 200;
            min-width: 180px;
            padding: 6px;
            grid-template-columns: 1fr 1fr 1fr;
        }
        .dropdown-menu.open { display: grid !important; }
        .dropdown-item {
            padding: 9px 14px;
            text-decoration: none;
            color: #1e3c72;
            font-weight: 700;
            font-size: 0.9em;
            border-radius: 6px;
            transition: all 0.15s;
            text-align: center;
            display: block;
        }
        .dropdown-item:hover { background: #c41e3a; color: white; }

    </style>
    <!-- Firebase Configuration -->
    <script type="module">
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBpsal5vJ1b4nEjAfyQH1baKFRcuPV4QxI",
      authDomain: "buster-league-draft.firebaseapp.com",
      databaseURL: "https://buster-league-draft-default-rtdb.firebaseio.com",
      projectId: "buster-league-draft",
      storageBucket: "buster-league-draft.firebasestorage.app",
      messagingSenderId: "410413976342",
      appId: "1:410413976342:web:2ed683daa1c808a2aa9e37",
      measurementId: "G-DNJ7MC9VLW"
    };

    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Make Firebase available globally
    window.firebaseApp = app;
    window.firebaseDB = db;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseGet = get;
    window.firebaseOnValue = onValue;
    window.firebaseInitialized = true;

    console.log('Firebase initialized successfully');

        // ===== FIREBASE REAL-TIME SYNC =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing Firebase real-time sync...');
            
            // Wait for Firebase to initialize
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            if (window.firebaseInitialized) {
                try {
                    // Load initial data from Firebase
                    const draftSnapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'draftedPlayers'));
                    if (draftSnapshot.exists()) {
                        draftedPlayers = draftSnapshot.val();
                        console.log('Loaded', draftedPlayers.length, 'drafted players from Firebase');
                    }
                    
                    const stateSnapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'draftState/currentPickIndex'));
                    if (stateSnapshot.exists()) {
                        currentPickIndex = stateSnapshot.val();
                        console.log('Current pick:', currentPickIndex);
                    }
                    
                    renderAll();
                    
                    // Listen for draft pick changes from other users
                    window.firebaseOnValue(window.firebaseRef(window.firebaseDB, 'draftedPlayers'), (snapshot) => {
                        const firebaseData = snapshot.val() || [];
                        // Check if there are new picks (count changed)
                        if (firebaseData.length !== draftedPlayers.length) {
                            console.log('Draft updated by another user -', firebaseData.length, 'picks');
                            // Unsanitize the Firebase data (convert H_9 back to H/9, etc.)
                            const unsanitizedData = unsanitizeFromFirebase(firebaseData);
                            draftedPlayers = unsanitizedData;
                            // Also update localStorage for this browser
                            localStorage.setItem('busterLeagueDraft', JSON.stringify({
                                draftedPlayers: draftedPlayers,
                                currentPickIndex: firebaseData.length
                            }));
                            currentPickIndex = firebaseData.length;
                            renderAll();
                        }
                    });
                    
                    // Listen for draft state changes
                    window.firebaseOnValue(window.firebaseRef(window.firebaseDB, 'draftState/currentPickIndex'), (snapshot) => {
                        const pickIndex = snapshot.val();
                        if (pickIndex !== null && pickIndex !== currentPickIndex) {
                            console.log('Pick position updated by another user');
                            currentPickIndex = pickIndex;
                            renderAll();
                        }
                    });
                    
                    console.log('Firebase real-time sync enabled');
                } catch (error) {
                    console.error('Firebase init error:', error);
                }
            } else {
                console.warn('Firebase not available');
            }
        });
    </script>
    <script src="draft-utils.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div>
                    <h1>‚öæ Buster League Draft 2026 <span style="font-size:0.5em;background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:20px;vertical-align:middle;letter-spacing:1px;">ADMIN</span></h1>
                    <p>Draft Board</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                <a href="index.html" class="nav-button">‚Üê Dashboard</a>
                <a href="login.html" class="nav-button secondary">Team Login</a>
                </div>
            </div>
            </div>
            
        </div>

        <div class="draft-status">
            <div class="draft-status-content">
                <div class="current-pick">
                    <span id="current-pick-text">Pick 1 - PHI is on the clock</span>
                </div>
                <div class="pick-info">
                    Round <span id="current-round">1</span> ‚Ä¢ Pick <span id="current-pick-number">1</span> of <span id="total-picks">20</span>
                </div>
                <button class="undo-button" id="undo-button" onclick="undoLastPick()" disabled style="margin-left:20px;">Undo Last Pick</button>
                <button class="undo-button" onclick="restartDraft()" style="margin-left:10px;background:#dc3545;">Restart Draft</button>
            </div>
        </div>


        <div class="main-content">
            <div class="draft-order">
                <h2>Draft Order</h2>
                <div id="draft-order-list"></div>
            </div>

            <div class="players-section">
                <!-- On the Clock Team Info -->
                <div id="on-clock-info" style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;border:2px solid #1e3c72;">
                    <h3 style="color:#1e3c72;margin:0 0 10px 0;display:flex;align-items:center;gap:10px;">
                        <span id="on-clock-team-name" style="font-size:1.2em;font-weight:700;"></span>
                        <span style="font-size:0.9em;color:#6c757d;font-weight:400;">On the Clock</span>
                    </h3>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <!-- Position Needs -->
                        <div>
                            <strong style="color:#1e3c72;font-size:0.9em;display:block;margin-bottom:8px;">POSITION NEEDS:</strong>
                            <div id="on-clock-needs" style="display:grid;grid-template-columns:repeat(3,1fr);gap:5px;font-size:0.85em;"></div>
                        </div>
                        
                        <!-- Rostered Players -->
                        <div>
                            <strong style="color:#1e3c72;font-size:0.9em;display:block;margin-bottom:8px;">ROSTER (<span id="on-clock-roster-count">0</span> players):</strong>
                            <div id="on-clock-roster" style="max-height:200px;overflow-y:auto;font-size:0.85em;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="filter-group">
                        <label for="position-filter">Position:</label>
                        <select id="position-filter">
                            <option value="all">All Positions</option>
                            <option value="all_pitchers">All Pitchers</option>
                            <option value="all_hitters">All Hitters</option>
                            <option value="SP">Starting Pitcher (SP)</option>
                            <option value="RP">Relief Pitcher (RP)</option>
                            <option value="C">Catcher (C)</option>
                            <option value="1b">First Base (1B)</option>
                            <option value="2b">Second Base (2B)</option>
                            <option value="3b">Third Base (3B)</option>
                            <option value="ss">Shortstop (SS)</option>
                            <option value="lf">Left Field (LF)</option>
                            <option value="cf">Center Field (CF)</option>
                            <option value="rf">Right Field (RF)</option>
                            <option value="dh">Designated Hitter (DH)</option>
                        </select>
                    </div>

                    <div class="filter-group search-box">
                        <label for="search">Search:</label>
                        <input type="text" id="search" placeholder="Search by name or team...">
                    </div>

                    <div class="filter-group">
                        <label for="show-drafted">
                            <input type="checkbox" id="show-drafted" style="width: auto;">
                            Show Unavailable
                        </label>
                    </div>
                </div>

                <div class="player-count" id="player-count"></div>

                <div class="players-table">
                    <table id="players-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="Last">Name</th>
                                <th class="sortable" data-column="Team">Team</th>
                                <th class="sortable" data-column="P">Pos</th>
                                <th>C</th>
                                <th>1B</th>
                                <th>2B</th>
                                <th>3B</th>
                                <th>SS</th>
                                <th>LF</th>
                                <th>CF</th>
                                <th>RF</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="players-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="draft-history">
            <h2>Draft History (<span id="total-drafted">0</span> players drafted)</h2>
            <div class="draft-picks-grid" id="draft-history"></div>
        </div>

        <div class="draft-history" style="margin-top: 20px;">
            <h2>Team Rosters</h2>
            <div class="controls" style="margin-bottom: 15px;">
                <div class="filter-group">
                    <label for="roster-team-filter">View Team:</label>
                    <select id="roster-team-filter" onchange="renderRosters()">
                        <option value="all">All Teams</option>
                    </select>
                </div>
            </div>
            <div id="team-rosters"></div>
        </div>
    </div>

    <script>
// Shared data management via localStorage
        // Sanitize player data for Firebase (remove invalid characters from keys)
        function sanitizeForFirebase(obj) {
            if (obj === null || obj === undefined) return obj;
            if (typeof obj !== 'object') return obj;
            if (Array.isArray(obj)) return obj.map(sanitizeForFirebase);
            
            const sanitized = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    // Replace invalid Firebase characters in keys
                    const sanitizedKey = key.replace(/[.#$\/\[\]]/g, '_');
                    sanitized[sanitizedKey] = sanitizeForFirebase(obj[key]);
                }
            }
            return sanitized;
        }

        // Unsanitize data coming from Firebase (convert H_9 back to H/9, etc.)
        function unsanitizeFromFirebase(obj) {
            if (obj === null || obj === undefined) return obj;
            if (typeof obj !== 'object') return obj;
            if (Array.isArray(obj)) return obj.map(unsanitizeFromFirebase);
            
            const unsanitized = {};
            // Map of sanitized keys back to original keys
            const keyMap = {
                'H_9': 'H/9',
                'K_9': 'K/9',
                'BB_9': 'BB/9',
                'HR_9': 'HR/9'
            };
            
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    // Check if this key needs to be unsanitized
                    const originalKey = keyMap[key] || key;
                    unsanitized[originalKey] = unsanitizeFromFirebase(obj[key]);
                }
            }
            return unsanitized;
        }

        function saveDraftState() {
            // Save to localStorage as backup
            localStorage.setItem('busterLeagueDraft', JSON.stringify({
                draftedPlayers: draftedPlayers,
                currentPickIndex: currentPickIndex
            }));
            
            // Save to Firebase for real-time sync
            if (window.firebaseInitialized) {
                // Sanitize player data for Firebase
                const sanitizedPlayers = sanitizeForFirebase(draftedPlayers);
                window.firebaseSet(window.firebaseRef(window.firebaseDB, 'draftedPlayers'), sanitizedPlayers).catch(error => {
                    console.error('Firebase save error:', error);
                });
                window.firebaseSet(window.firebaseRef(window.firebaseDB, 'draftState/currentPickIndex'), currentPickIndex).catch(error => {
                    console.error('Firebase save error:', error);
                });
            }
        }
        // Team names in draft order

        // Initialize with embedded data
        let players = [];
        let draftedPlayers = [];
        let currentPickIndex = 0;
        let sortColumn = null;
        let sortDirection = 'asc';

        console.log(`Loaded ${players.length} players`);        function filterPlayers() {
            const posFilterElem = document.getElementById('position-filter');
            const searchElem = document.getElementById('search');
            const showDraftedElem = document.getElementById('show-drafted');
            
            const positionFilter = posFilterElem ? posFilterElem.value : 'all';
            const searchTerm = searchElem ? searchElem.value.toLowerCase() : '';
            const showDrafted = showDraftedElem ? showDraftedElem.checked : false;
            
            let filtered = players.filter(player => {
                // Check if drafted in current draft
                const isDrafted = draftedPlayers.some(dp => 
                    dp.player.First === player.First && dp.player.Last === player.Last
                );
                
                // Check if pre-drafted
                const isPreDraft = isPreDrafted(player);
                
                // Hide both drafted and pre-drafted players unless "Show Drafted" is checked
                if ((isDrafted || isPreDraft) && !showDrafted) return false;
                
                // Position filter
                if (positionFilter !== 'all') {
                    const playerPos = getPlayerPosition(player);
                    
                    if (positionFilter === 'all_pitchers') {
                        if (playerPos !== 'SP' && playerPos !== 'RP') return false;
                    } else if (positionFilter === 'all_hitters') {
                        if (playerPos === 'SP' || playerPos === 'RP') return false;
                    } else {
                        if (playerPos !== positionFilter) return false;
                    }
                }
                
                // Search filter
                if (searchTerm) {
                    const fullName = `${player.First} ${player.Last}`.toLowerCase();
                    const team = (player.Team || '').toLowerCase();
                    if (!fullName.includes(searchTerm) && !team.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Apply sorting
            if (sortColumn) {
                filtered.sort((a, b) => {
                    let aVal = a[sortColumn];
                    let bVal = b[sortColumn];
                    
                    // Handle null/undefined values
                    if (aVal == null) aVal = sortDirection === 'asc' ? Infinity : -Infinity;
                    if (bVal == null) bVal = sortDirection === 'asc' ? Infinity : -Infinity;
                    
                    // Numeric comparison
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                    
                    // String comparison
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                    
                    if (sortDirection === 'asc') {
                        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    } else {
                        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    }
                });
            }
            
            return filtered;
        }

        function renderPlayers() {
            const tbody = document.getElementById('players-tbody');
            const filtered = filterPlayers();
            
            const preDraftedCount = players.filter(p => isPreDrafted(p)).length;
            const availableCount = players.length - preDraftedCount - draftedPlayers.length;
            
            document.getElementById('player-count').textContent = 
                `Showing ${filtered.length} players ‚Ä¢ ${availableCount} available ‚Ä¢ ${draftedPlayers.length} drafted ‚Ä¢ ${preDraftedCount} keepers`;
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 40px; color: #6c757d;">No players found matching your filters</td></tr>';
                return;
            }
            
            const html = filtered.map((player, index) => {
                const isDrafted = draftedPlayers.some(dp => 
                    dp.player.First === player.First && dp.player.Last === player.Last
                );
                
                const draftedInfo = isDrafted ? 
                    draftedPlayers.find(dp => dp.player.First === player.First && dp.player.Last === player.Last) : 
                    null;
                
                const isPreDraft = isPreDrafted(player);
                
                const eligiblePositions = getEligiblePositions(player);
                const posDisplay = eligiblePositions.map(p => p.toUpperCase()).join('/');
                const position = getPlayerPosition(player);
                const isPitcher = position === 'SP' || position === 'RP';
                
                // Create unique identifier for player
                const playerKey = `${player.First}|${player.Last}|${player.Age}`;
                
                // Get field ratings for all positions
                const positions = ['c', '1b', '2b', '3b', 'ss', 'lf', 'cf', 'rf'];
                const ratings = positions.map(pos => player[pos] || '-');
                
                return `
                    <tr class="${isDrafted || isPreDraft ? 'drafted' : ''}" data-player="${playerKey}">
                        <td>${player.First} ${player.Last}</td>
                        <td>${player.Team || '-'}</td>
                        <td><span class="position-badge">${posDisplay}</span></td>
                        <td>${ratings[0]}</td>
                        <td>${ratings[1]}</td>
                        <td>${ratings[2]}</td>
                        <td>${ratings[3]}</td>
                        <td>${ratings[4]}</td>
                        <td>${ratings[5]}</td>
                        <td>${ratings[6]}</td>
                        <td>${ratings[7]}</td>
                        <td>
                            ${isPreDraft ? 
                                `<span class="drafted-by">Keeper: ${player.Team}</span>` :
                                isDrafted ? 
                                `<span class="drafted-by">${draftedInfo.team}</span>` : 
                                `<button class="draft-button" onclick="draftPlayerByKey('${playerKey}')">Draft</button>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
        }
        function restartDraft() {
            const confirmation = prompt('Are you sure you want to restart the entire draft? This will clear ALL picks!\n\nType "RESTART" to confirm:');
            
            if (confirmation !== 'RESTART') {
                alert('Draft restart cancelled.');
                return;
            }
            
            // Clear everything
            draftedPlayers = [];
            currentPickIndex = 0;
            
            // Save to localStorage
            localStorage.removeItem('busterLeagueDraft');
            saveDraftState();
            
            // Clear Firebase
            if (window.firebaseInitialized) {
                window.firebaseSet(window.firebaseRef(window.firebaseDB, 'draftedPlayers'), []).catch(error => {
                    console.error('Firebase clear error:', error);
                });
                window.firebaseSet(window.firebaseRef(window.firebaseDB, 'draftState/currentPickIndex'), 0).catch(error => {
                    console.error('Firebase clear error:', error);
                });
                console.log('Draft restarted - Firebase cleared');
            }
            
            renderAll();
            alert('Draft has been restarted! All picks have been cleared.');
        }

        function renderDraftHistory() {
            console.log('renderDraftHistory called, draftedPlayers:', draftedPlayers ? draftedPlayers.length : 0);
            const historyDiv = document.getElementById('draft-history');
            if (!historyDiv) {
                console.error('draft-history element not found');
                return;
            }
            document.getElementById('total-drafted').textContent = draftedPlayers.length;
            
            if (draftedPlayers.length === 0) {
                historyDiv.innerHTML = '<p style="color: #6c757d;">No picks yet</p>';
                return;
            }
            
            const html = draftedPlayers.slice().reverse().map(pick => {
                const position = getPlayerPosition(pick.player);
                return `
                    <div class="pick-item">
                        <div class="pick-number">Pick ${pick.pickNumber} (Round ${pick.round})</div>
                        <div style="font-weight: 600; margin: 5px 0;">${pick.player.First} ${pick.player.Last}</div>
                        <div style="color: #6c757d; font-size: 0.9em;">
                            ${pick.team} ‚Ä¢ ${position.toUpperCase()} ‚Ä¢ ${pick.player.Team || 'FA'}
                        </div>
                    </div>
                `;
            }).join('');
            
            historyDiv.innerHTML = html;
            document.getElementById('undo-button').disabled = draftedPlayers.length === 0;
        }

        function renderRosters() {
            const rostersDiv = document.getElementById('team-rosters');
            const selectedTeam = document.getElementById('roster-team-filter').value;
            
            // Position requirements
            const requirements = {
                'C': 3, 'SP': 8, 'RP': 8,
                '1B': 2, '2B': 2, '3B': 2, 'SS': 2,
                'LF': 2, 'CF': 2, 'RF': 2, 'DH': 2
            };
            
            // Build rosters for each team
            const rosters = {};
            teams.forEach(team => {
                rosters[team] = {
                    preDrafted: [],
                    drafted: [],
                    positionCounts: {}
                };
                // Initialize position counts
                Object.keys(requirements).forEach(pos => {
                    rosters[team].positionCounts[pos] = 0;
                });
            });
            
            // Add pre-drafted players
            players.forEach(player => {
                if (isPreDrafted(player)) {
                    const teamKey = player.Team.toUpperCase();
                    if (rosters[teamKey]) {
                        rosters[teamKey].preDrafted.push(player);
                        getEligiblePositions(player).forEach(function(pos) {
                            const key = pos.toUpperCase();
                            if (rosters[teamKey].positionCounts[key] !== undefined) {
                                rosters[teamKey].positionCounts[key]++;
                            }
                        });
                    }
                }
            });
            
            // Add drafted players
            draftedPlayers.forEach(pick => {
                if (rosters[pick.team]) {
                    rosters[pick.team].drafted.push(pick);
                    getEligiblePositions(pick.player).forEach(function(pos) {
                        const key = pos.toUpperCase();
                        if (rosters[pick.team].positionCounts[key] !== undefined) {
                            rosters[pick.team].positionCounts[key]++;
                        }
                    });
                }
            });
            
            // Filter teams if needed
            const teamsToShow = selectedTeam === 'all' ? teams : [selectedTeam];
            
            // Generate HTML
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">';
            
            teamsToShow.forEach(team => {
                const roster = rosters[team];
                const totalPlayers = roster.preDrafted.length + roster.drafted.length;
                
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #dee2e6;">
                        <h3 style="color: #1e3c72; margin-bottom: 10px; border-bottom: 2px solid #c41e3a; padding-bottom: 8px;">
                            ${team} (${totalPlayers} players)
                        </h3>
                `;
                
                // Position requirements display
                html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #dee2e6;">';
                html += '<strong style="color: #1e3c72; font-size: 0.9em; display: block; margin-bottom: 8px;">POSITION NEEDS:</strong>';
                html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; font-size: 0.85em;">';
                
                // Group positions for display
                const positionGroups = [
                    { label: 'C', pos: 'C' },
                    { label: 'SP', pos: 'SP' },
                    { label: 'RP', pos: 'RP' },
                    { label: '1B', pos: '1B' },
                    { label: '2B', pos: '2B' },
                    { label: '3B', pos: '3B' },
                    { label: 'SS', pos: 'SS' },
                    { label: 'LF', pos: 'LF' },
                    { label: 'CF', pos: 'CF' },
                    { label: 'RF', pos: 'RF' },
                    { label: 'DH', pos: 'DH' }
                ];
                
                positionGroups.forEach(pg => {
                    const current = roster.positionCounts[pg.pos];
                    const needed = requirements[pg.pos];
                    const remaining = needed - current;
                    const isComplete = remaining <= 0;
                    const color = current < 2 ? '#dc3545' : (isComplete ? '#28a745' : (remaining <= 1 ? '#ffc107' : '#dc3545'));
                    
                    html += `<div style="padding: 3px 0;">
                        <span style="font-weight: 600;">${pg.label}:</span> 
                        <span style="color: ${color}; font-weight: 700;">${current}/${needed}</span>
                        ${!isComplete ? `<span style="color: #6c757d; font-size: 0.9em;"> (need ${remaining})</span>` : ' ‚úî'}
                    </div>`;
                });
                
                html += '</div></div>';
                
                // Position summary box
                html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #dee2e6;">';
                html += '<strong style="color: #1e3c72; font-size: 0.9em; display: block; margin-bottom: 8px;">POSITION BREAKDOWN:</strong>';
                html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; font-size: 0.85em;">';
                
                // Count all positions (keys are uppercase)
                const allPositions = ['C', 'SP', 'RP', '1B', '2B', '3B', 'SS', 'LF', 'CF', 'RF', 'DH'];
                
                allPositions.forEach(pos => {
                    const count = roster.positionCounts[pos] || 0;
                    html += `<div style="padding: 3px 0;">
                        <span style="font-weight: 600;">${pos}:</span> 
                        <span style="color: #1e3c72; font-weight: 700;">${count}</span>
                    </div>`;
                });
                
                html += '</div></div>';
                
                // Players list
                const allPlayers = [
                    ...roster.preDrafted.map(p => ({ player: p, type: 'keeper', pickNumber: null })),
                    ...roster.drafted.map(d => ({ player: d.player, type: 'drafted', pickNumber: d.pickNumber }))
                ];
                
                if (allPlayers.length > 0) {
                    html += '<div style="margin-bottom: 15px;">';
                    html += '<strong style="color: #6c757d; font-size: 0.9em;">ROSTER:</strong>';
                    
                    allPlayers.forEach(item => {
                        const eligiblePositions = getEligiblePositions(item.player);
                        const posDisplay = eligiblePositions.map(p => p.toUpperCase()).join('/');
                        const typeLabel = item.type === 'keeper' ? 
                            '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 5px;">K</span>' : 
                            `<span style="color: #6c757d; font-size: 0.85em;"> (Pick ${item.pickNumber})</span>`;
                        
                        html += `<div style="padding: 5px 0; font-size: 0.9em; border-bottom: 1px solid #e9ecef;">
                            ${item.player.First} ${item.player.Last} 
                            <span style="color: #c41e3a; font-weight: 600;">${posDisplay}</span>
                            ${typeLabel}
                        </div>`;
                    });
                    
                    html += '</div>';
                }
                
                if (totalPlayers === 0) {
                    html += '<div style="color: #6c757d; font-style: italic; padding: 10px 0;">No players yet</div>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            rostersDiv.innerHTML = html;
        }


        function updateOnClockTeamInfo() {
            const currentTeam = getCurrentTeam();
            document.getElementById('on-clock-team-name').textContent = currentTeam;
            
            // Get team's roster
            const teamRoster = [];
            
            // Add pre-drafted players
            players.forEach(player => {
                if (isPreDrafted(player) && player.Team && player.Team.toUpperCase() === currentTeam) {
                    teamRoster.push({ player: player, type: 'keeper' });
                }
            });
            
            // Add drafted players
            draftedPlayers.forEach(pick => {
                if (pick.team === currentTeam) {
                    teamRoster.push({ player: pick.player, type: 'drafted' });
                }
            });
            
            // Update roster count
            document.getElementById('on-clock-roster-count').textContent = teamRoster.length;
            
            // Calculate position counts
            const requirements = {
                'C': 3, 'SP': 8, 'RP': 8,
                '1B': 2, '2B': 2, '3B': 2, 'SS': 2,
                'LF': 2, 'CF': 2, 'RF': 2, 'DH': 2
            };
            
            const positionCounts = {};
            Object.keys(requirements).forEach(pos => {
                positionCounts[pos] = 0;
            });
            
            // Count positions (multi-position players count for all)
            teamRoster.forEach(item => {
                getEligiblePositions(item.player).forEach(function(pos) {
                    const key = pos.toUpperCase();
                    if (positionCounts[key] !== undefined) {
                        positionCounts[key]++;
                    }
                });
            });
            
            // Render position needs
            const posLabels = {
                'C': 'C', 'SP': 'SP', 'RP': 'RP',
                '1B': '1B', '2B': '2B', '3B': '3B', 'SS': 'SS',
                'LF': 'LF', 'CF': 'CF', 'RF': 'RF', 'DH': 'DH'
            };
            
            let needsHtml = '';
            Object.keys(requirements).forEach(pos => {
                const current = positionCounts[pos];
                const needed = requirements[pos];
                const color = current < 2 ? '#dc3545' : (current >= needed ? '#28a745' : '#ffc107');
                needsHtml += `<div style="padding:3px 0;">
                    <span style="font-weight:600;">${posLabels[pos]}:</span> 
                    <span style="color:${color};font-weight:700;">${current}/${needed}</span>
                </div>`;
            });
            document.getElementById('on-clock-needs').innerHTML = needsHtml;
            
            // Render roster
            let rosterHtml = '';
            if (teamRoster.length === 0) {
                rosterHtml = '<div style="color:#6c757d;font-style:italic;">No players yet</div>';
            } else {
                teamRoster.forEach(item => {
                    const eligiblePositions = getEligiblePositions(item.player);
                    const posDisplay = eligiblePositions.map(p => p.toUpperCase()).join('/');
                    const typeLabel = item.type === 'keeper' ? 
                        '<span style="background:#28a745;color:white;padding:2px 6px;border-radius:3px;font-size:0.75em;margin-left:5px;">K</span>' : '';
                    
                    rosterHtml += `<div style="padding:3px 0;border-bottom:1px solid #e9ecef;">
                        ${item.player.First} ${item.player.Last} 
                        <span style="color:#c41e3a;font-weight:600;">${posDisplay}</span>
                        ${typeLabel}
                    </div>`;
                });
            }
            document.getElementById('on-clock-roster').innerHTML = rosterHtml;
        }

        function renderAll() {
            console.log('renderAll called');
            updateDraftStatus();
            updateOnClockTeamInfo();
            renderDraftOrder(10);
            renderPlayers();
            renderDraftHistory();
            renderRosters();
        }

        // Sorting functionality
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.column;
                
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                
                // Update sort indicators
                document.querySelectorAll('th.sortable').forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                });
                
                th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                
                renderPlayers();
            });
        });

        // Event listeners (only attach if elements exist)
        const posFilter = document.getElementById('position-filter');
        if (posFilter) posFilter.addEventListener('change', renderPlayers);
        
        const searchInput = document.getElementById('search');
        if (searchInput) searchInput.addEventListener('input', renderPlayers);
        
        const showDrafted = document.getElementById('show-drafted');
        if (showDrafted) showDrafted.addEventListener('change', renderPlayers);

        // Initialize when page loads
        
        // Auto-sync when data changes in another tab/window
        window.addEventListener('storage', function(e) {
            if (e.key === 'busterLeagueDraft' && e.newValue) {
                console.log('Draft data changed in another tab, reloading...');
                loadDraftState();
                renderAll();
            }
        });
        
        // Also check on page focus (when you switch back to this tab)
        window.addEventListener('focus', function() {
            console.log('Page focused, checking for updates...');
            loadDraftState();
            renderAll();
        });


        // Dropdown open/close
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open'));
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open'));
            }
        });
        window.addEventListener('DOMContentLoaded', async () => {
            // Admin-only guard
            const loggedTeam = localStorage.getItem('busterLeagueTeam');
            if (loggedTeam !== 'ADMIN') {
                document.body.innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#1e3c72,#2a5298);flex-direction:column;gap:20px;">
                        <div style="background:white;border-radius:16px;padding:48px 40px;text-align:center;max-width:380px;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                            <div style="font-size:3em;margin-bottom:12px;">üèÜ</div>
                            <h2 style="color:#1e3c72;font-size:1.4em;margin-bottom:8px;">Admin Only</h2>
                            <p style="color:#6c757d;margin-bottom:24px;font-size:0.95em;">The draft board is restricted to the commissioner. Please log in with your admin credentials.</p>
                            <a href="login.html" style="display:inline-block;background:#c41e3a;color:white;padding:12px 28px;border-radius:8px;font-weight:700;text-decoration:none;font-size:1em;">Go to Login ‚Üí</a>
                        </div>
                    </div>`;
                return;
            }
            players = await fetch('players.json').then(r => r.json());
            loadDraftState();
            // Populate team roster dropdown
            const rosterSelect = document.getElementById('roster-team-filter');
            if (rosterSelect) {
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    rosterSelect.appendChild(option);
                });
            }
            
            renderAll();
        });
</script>
</body>
</html>